<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舞立方自制谱谱师工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 头部区域 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .logo-area {
            display: flex;
            align-items: center;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            margin-right: 15px;
        }

        .logo-text h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .logo-text p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        /* 用户登录区域 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .login-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 222, 128, 0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .user-id {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .logout-btn {
            padding: 5px 10px;
            background: #f87171;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* 登录模态框 */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .login-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .login-content {
            background-color: white;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            position: relative;
            transform: translateY(30px);
            transition: transform 0.4s ease;
        }

        .login-modal.active .login-content {
            transform: translateY(0);
        }

        .login-header {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
        }

        .login-header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .login-header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .login-body {
            padding: 30px;
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        .qr-placeholder {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            background: #f5f5f5;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            border: 2px dashed #ddd;
            cursor: pointer;
        }

        .qr-placeholder:hover {
            background: #f0f0f0;
        }

        .qr-placeholder i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #6a11cb;
        }

        #login-qrcode-img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
        }

        .login-status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .login-status.waiting {
            background: #fef3c7;
            color: #d97706;
        }

        .login-status.scanned {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .login-status.success {
            background: #d1fae5;
            color: #059669;
        }

        .login-status.error {
            background: #fee2e2;
            color: #dc2626;
        }

        .login-expire-time {
            text-align: center;
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .login-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
        }

        /* 搜索和筛选区域 */
        .search-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .search-box {
            flex: 1;
            position: relative;
            max-width: 500px;
        }

        .search-box input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: none;
            border-radius: 15px;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            font-size: 1rem;
            color: #333;
        }

        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-tab {
            padding: 12px 25px;
            background-color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .filter-tab.active, .filter-tab:hover {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
        }

        /* 工具区域 */
        .tools-section {
            margin-bottom: 60px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-header h2 {
            font-size: 1.8rem;
            color: #2c3e50;
        }

        .section-header p {
            color: #7f8c8d;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .tool-card {
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .tool-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .tool-card.featured {
            border-top: 5px solid #ff9a00;
        }

        .tool-card.new {
            border-top: 5px solid #6a11cb;
        }

        .tool-card.second {
            border-top: 5px solid #ff0000;
        }

        .tool-card.official {
            border-top: 5px solid #003cff;
        }

        .tool-header {
            padding: 25px 25px 15px;
            display: flex;
            align-items: center;
        }

        .tool-icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .tool-info h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .tool-info p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .tool-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #ffffff;
        }

        .featured-badge {
            background-color: #ff9a00;
        }

        .new-badge {
            background-color: #6a11cb;
        }

        .official-badge {
            background-color: #0059ff;
        }

        .second-badge {
            background-color: #ff0000;
        }

        .tool-description {
            padding: 0 25px 20px;
            color: #666;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .tool-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tool-stats {
            display: flex;
            gap: 15px;
        }

        .tool-stat {
            display: flex;
            align-items: center;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .tool-stat i {
            margin-right: 5px;
        }

        .tool-action {
            padding: 10px 25px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .tool-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(37, 117, 252, 0.3);
        }

        /* 底部区域 */
        .footer {
            text-align: center;
            padding: 30px 0;
            color: #7f8c8d;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }

        /* 工具详情模态框 */
        .tool-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .tool-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: 25px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(30px);
            transition: transform 0.4s ease;
        }

        .tool-modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 25px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #7f8c8d;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .modal-header {
            padding: 40px 40px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .modal-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.2rem;
            margin-right: 25px;
            flex-shrink: 0;
        }

        .modal-title h2 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .modal-title p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .modal-body {
            padding: 30px 40px;
        }

        .modal-section {
            margin-bottom: 30px;
        }

        .modal-section h3 {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .modal-section p {
            line-height: 1.6;
            color: #555;
            margin-bottom: 15px;
        }

        .modal-features {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .modal-feature {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .modal-feature i {
            color: #2575fc;
            font-size: 1.2rem;
            margin-right: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-btn {
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .modal-btn.primary {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
        }

        .modal-btn.secondary {
            background-color: #f8f9fa;
            color: #555;
            border: 1px solid #ddd;
        }

        .modal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.1);
        }

        /* 响应式设计 */
        @media (max-width: 1100px) {
            .tools-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }

            .user-info {
                width: 100%;
                justify-content: flex-end;
            }

            .search-filter {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-box {
                max-width: 100%;
            }

            .filter-tabs {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 10px;
            }

            .modal-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .modal-icon {
                margin-bottom: 20px;
            }

            .modal-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }

            .tool-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .tool-icon {
                margin-bottom: 15px;
            }

            .modal-body {
                padding: 20px;
            }

            .user-details {
                display: none;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- 头部区域 -->
    <header class="header">
        <div class="logo-area">
            <div class="logo">
                <i class="fas fa-toolbox"></i>
            </div>
            <div class="logo-text">
                <h1>舞立方自制谱谱师工具（持续更新）</h1>
                <p>本页面工具已经测试，如有bug请联系：miqimiaomiaowushi@163.com</p>
            </div>
        </div>

        <!-- 用户登录信息 -->
        <div class="user-info" id="userInfo">
            <button class="login-btn" id="loginBtn">
                <i class="fab fa-weixin"></i> 微信登录
            </button>
            <!-- 登录后显示用户信息 -->
            <div class="user-details" id="userDetails" style="display: none;">
                <div class="user-name" id="userName"></div>
                <div class="user-id" id="userId"></div>
                <button class="logout-btn" id="logoutBtn">退出</button>
            </div>
            <div class="user-avatar" id="userAvatar" style="display: none;">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>

    <!-- 搜索区域 -->
    <div class="search-filter">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索工具或功能...">
            <i class="fas fa-search"></i>
        </div>
    </div>

    <!-- 所有工具区域 -->
    <section class="tools-section">
        <div class="section-header">
            <div>
                <h2>所有工具</h2>
                <p>选择您需要的工具</p>
            </div>
            <div>
                <p>共 <span id="toolCount">12</span> 个工具</p>
            </div>
        </div>

        <div class="tools-grid" id="toolsGrid">
            <!-- 工具卡片将通过JS动态生成 -->
        </div>
    </section>

    <!-- 底部区域 -->
    <footer class="footer">
        <p>2025 舞立方自制谱师工具 | 本页面由 Mouseke 进行开发 | 源码公开免费给大家使用 </p>
    </footer>
</div>

<!-- 微信登录模态框 -->
<div class="login-modal" id="loginModal">
    <div class="login-content">
        <button class="login-close" id="loginClose">
            <i class="fas fa-times"></i>
        </button>
        <div class="login-header">
            <h2>微信扫码登录</h2>
            <p>使用微信扫描二维码登录系统</p>
        </div>
        <div class="login-body">
            <div class="qr-container">
                <div class="qr-placeholder" id="loginQrPlaceholder">
                    <i class="fas fa-qrcode"></i>
                    <p>点击生成二维码</p>
                </div>
                <img id="login-qrcode-img" alt="微信登录二维码" style="display:none;">
            </div>
            <div class="login-status" id="loginStatus">
                请点击上方二维码区域生成二维码
            </div>
            <div class="login-expire-time" id="loginExpireTime" style="display:none;">
                二维码有效期：15分钟
            </div>
        </div>
    </div>
</div>

<!-- 工具详情模态框 -->
<div class="tool-modal" id="toolModal">
    <div class="modal-content">
        <button class="modal-close" id="modalClose">
            <i class="fas fa-times"></i>
        </button>

        <div class="modal-header">
            <div class="modal-icon" id="modalIcon">
                <i class="fas fa-palette"></i>
            </div>
            <div class="modal-title">
                <h2 id="modalToolName">设计编辑器</h2>
                <p id="modalToolCategory">设计工具 · 高级功能</p>
            </div>
        </div>

        <div class="modal-body">
            <div class="modal-section">
                <h3>工具描述</h3>
                <p id="modalToolDescription">这是一个功能强大的设计编辑器，提供丰富的设计工具和模板，帮助您快速创建精美的设计作品。支持实时协作、版本管理和多种导出格式。</p>
            </div>

            <div class="modal-section">
                <h3>主要功能</h3>
                <div class="modal-features" id="modalFeatures">
                    <!-- 功能列表将通过JS动态生成 -->
                </div>
            </div>

            <div class="modal-actions">
                <a class="modal-btn primary" id="openToolBtn" target="_blank">
                    <i class="fas fa-external-link-alt"></i> 打开工具
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // 工具数据 - 更新为舞立方相关的工具
    const toolsData = [
        {
            id: 1,
            name: "自制谱上传工具",
            category: "upload",
            description: "上传您的自制谱到机器上",
            icon: "fa-solid fa-upload",
            iconColor: "#0033ff",
            official: true,
            features: ["直接跳转"],
            url: "https://danceweb.shenghuayule.com/MusicMaker/#/"
        },
        {
            id: 2,
            name: "txt转mc/mcz",
            category: "exchange",
            description: "将txt文件转换为mc文件，并且支持打包为mcz文件",
            icon: "fas fa-music",
            iconColor: "#6a11cb",
            featured: true,
            features: ["自动转换", "不同小节转换", "自动计算偏移", "支持打包", "如果偏移不准请在游戏内重新测试"],
            url: "../txt-mc.html"
        },
        {
            id: 3,
            name: "歌曲封面剪裁",
            category: "cut",
            description: "将图片裁剪为可上传大小",
            icon: "fas fa-image",
            iconColor: "#117ecb",
            featured: true,
            features: ["自动裁剪", "jpg格式", "直接下载"],
            url: "../picturecut.html"
        },
        {
            id: 4,
            name: "标题图制作",
            category: "make",
            description: "绘制标题图图片",
            icon: "fas fa-heading",
            iconColor: "#cb6511",
            featured: true,
            features: ["自动绘制", "png格式", "直接下载"],
            url: "../maketitle.html"
        },
        {
            id: 5,
            name: "音频转换",
            category: "exchange",
            description: "转换音频格式",
            icon: "fas fa-compact-disc",
            iconColor: "#b811cb",
            featured: true,
            features: ["自动监测上传文件格式", "多格式转换", "直接下载", "自由选择比特率"],
            url: "../exchange-radio.html"
        },
        {
            id: 6,
            name: "ncm转换",
            category: "exchange",
            description: "转换ncm格式",
            icon: "fas fa-arrows-rotate",
            iconColor: "#ff0000",
            featured: true,
            features: ["自动转换ncm文件", "多文件转换", "直接下载", "仅供学习"],
            url: "../ncmexchange.html"
        },
        {
            id: 7,
            name: "mc/mcz转txt",
            category: "exchange",
            description: "将mc/mcz文件转换为mc文件，并且支持打包为zip文件",
            icon: "fas fa-right-left",
            iconColor: "#e600ff",
            featured: true,
            features: ["自动转换", "不同小节转换", "自动打包zip", "支持自动解包", "包含变速转换","支持自动下载","自动生成上传数据文本文件","禁止导入官方制谱器，否则后果自负"],
            url: "../mc-txt.html"
        },
        {
            id: 8,
            name: "免费mp3下载",
            category: "download",
            description: "免费下载歌曲mp3音频、封面等等",
            icon: "fa-solid fa-download",
            iconColor: "#2ba31d",
            featured: true,
            features: ["免费下载"],
            url: "https://www.myfreemp3.com.cn/"
        },
        {
            id: 9,
            name: "舞立方自制谱谱师兑换码生成",
            category: "make",
            description: "可生成可以兑换歌曲各种时长的兑换码",
            icon: "fa-solid fa-gift",
            iconColor: "#520fc5",
            new: true,
            features: ["多种时长","生成永久","生成次数","生成小时","仅在浏览器使用"],
            url: "../gift.html"
        },
        {
            id: 10,
            name: "舞立方用户token获取",
            category: "token",
            description: "可获取舞立方用户token",
            icon: "fa-solid fa-key",
            iconColor: "#c5a007",
            new: true,
            features: ["扫码登录","获取token","直接复制","仅在浏览器使用"],
            url: "../gettoken.html"
        }
    ];

    // DOM元素
    const toolsGrid = document.getElementById('toolsGrid');
    const toolCount = document.getElementById('toolCount');
    const searchInput = document.getElementById('searchInput');
    const toolModal = document.getElementById('toolModal');
    const modalClose = document.getElementById('modalClose');
    const openToolBtn = document.getElementById('openToolBtn');
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('loginModal');
    const loginClose = document.getElementById('loginClose');
    const loginQrPlaceholder = document.getElementById('loginQrPlaceholder');
    const loginQrcodeImg = document.getElementById('login-qrcode-img');
    const loginStatus = document.getElementById('loginStatus');
    const loginExpireTime = document.getElementById('loginExpireTime');
    const userInfo = document.getElementById('userInfo');
    const userDetails = document.getElementById('userDetails');
    const userName = document.getElementById('userName');
    const userId = document.getElementById('userId');
    const userAvatar = document.getElementById('userAvatar');
    const logoutBtn = document.getElementById('logoutBtn');

    // 全局变量
    const API_BASE = 'https://dancedemo.shenghuayule.com/Dance';
    let currentToolId = null;
    let loginQrCodeData = null;
    let loginCheckInterval = null;
    let userData = null;

    // 初始化页面
    function initPage() {
        // 显示工具数量
        toolCount.textContent = toolsData.length;

        // 渲染所有工具
        renderTools(toolsData);

        // 检查用户登录状态
        checkLoginStatus();

        // 设置事件监听器
        setupEventListeners();
    }

    // 检查登录状态
    function checkLoginStatus() {
        const savedUserData = localStorage.getItem('dance_user_data');
        const savedToken = localStorage.getItem('dance_user_token');

        if (savedUserData && savedToken) {
            try {
                userData = JSON.parse(savedUserData);
                const tokenData = JSON.parse(savedToken);

                // 检查token是否过期
                if (tokenData.expireTime && new Date(tokenData.expireTime) > new Date()) {
                    // token有效，显示用户信息
                    showUserInfo(userData);
                    return true;
                } else {
                    // token过期，清除数据
                    clearUserData();
                    return false;
                }
            } catch (e) {
                console.error('解析用户数据失败:', e);
                clearUserData();
                return false;
            }
        }
        return false;
    }

    // 显示用户信息
    function showUserInfo(user) {
        userName.textContent = user.nickname || '微信用户';
        userId.textContent = `ID: ${user.userId || '未知'}`;
        userDetails.style.display = 'block';
        userAvatar.style.display = 'flex';
        loginBtn.style.display = 'none';

        // 设置头像背景色
        const avatarColors = ['#6a11cb', '#2575fc', '#4ade80', '#f59e0b', '#ef4444'];
        const colorIndex = (user.userId || '').toString().split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) % avatarColors.length;
        userAvatar.style.background = `linear-gradient(135deg, ${avatarColors[colorIndex]}99, ${avatarColors[colorIndex]})`;

        // 显示头像首字母
        const firstChar = userName.textContent.charAt(0).toUpperCase();
        userAvatar.innerHTML = firstChar;
    }

    // 清除用户数据
    function clearUserData() {
        localStorage.removeItem('dance_user_data');
        localStorage.removeItem('dance_user_token');
        userData = null;
        userDetails.style.display = 'none';
        userAvatar.style.display = 'none';
        loginBtn.style.display = 'flex';
    }

    // 生成登录二维码
    async function generateLoginQRCode() {
        try {
            loginStatus.textContent = '正在生成二维码...';
            loginStatus.className = 'login-status waiting';
            loginQrcodeImg.style.display = 'none';
            loginQrPlaceholder.style.display = 'flex';

            const response = await fetch(`${API_BASE}/api/Common/GetQrCode`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`二维码接口错误: ${response.status}`);
            }

            const data = await response.json();
            loginQrCodeData = data;

            // 显示二维码
            loginQrPlaceholder.style.display = 'none';
            loginQrcodeImg.src = data.QrcodeUrl;
            loginQrcodeImg.style.display = 'block';
            loginStatus.textContent = '请使用微信扫描二维码';
            loginStatus.className = 'login-status waiting';

            // 显示过期时间
            if (data.ExpireTime) {
                const expireTime = new Date(data.ExpireTime);
                const timeStr = expireTime.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                loginExpireTime.textContent = `二维码有效期至: ${timeStr}`;
                loginExpireTime.style.display = 'block';
            }

            // 开始轮询登录状态
            startLoginPolling();

            // 设置二维码过期检查
            if (data.ExpireTime) {
                const expireTime = new Date(data.ExpireTime);
                const now = new Date();
                const timeDiff = expireTime - now;

                if (timeDiff > 0) {
                    setTimeout(() => {
                        loginStatus.textContent = '二维码已过期，请刷新';
                        loginStatus.className = 'login-status error';
                        loginExpireTime.textContent = '二维码已过期';

                        if (loginCheckInterval) {
                            clearInterval(loginCheckInterval);
                            loginCheckInterval = null;
                        }
                    }, timeDiff);
                }
            }

        } catch (error) {
            console.error('生成二维码失败:', error);
            loginStatus.textContent = '生成失败，请重试';
            loginStatus.className = 'login-status error';
            loginQrPlaceholder.style.display = 'flex';
            loginQrcodeImg.style.display = 'none';
        }
    }

    // 开始轮询登录状态
    function startLoginPolling() {
        if (loginCheckInterval) {
            clearInterval(loginCheckInterval);
        }

        loginCheckInterval = setInterval(async () => {
            if (!loginQrCodeData?.ID) return;

            try {
                const params = new URLSearchParams({
                    client_type: 'qrcode',
                    grant_type: 'client_credentials',
                    client_id: loginQrCodeData.ID
                });

                const response = await fetch(`${API_BASE}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: params.toString()
                });

                if (response.status === 401) {
                    // 等待扫码
                    loginStatus.textContent = '等待扫码...';
                    loginStatus.className = 'login-status waiting';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Token接口错误: ${response.status}`);
                }

                const data = await response.json();
                const token = data.access_token || data.accessToken;

                if (token) {
                    // 登录成功
                    clearInterval(loginCheckInterval);
                    loginCheckInterval = null;

                    loginStatus.textContent = '登录成功！';
                    loginStatus.className = 'login-status success';

                    // 获取用户信息（这里需要根据实际API调整）
                    // 假设token中包含用户信息，或者需要调用其他接口获取
                    const userInfo = await getUserInfo(token);

                    if (userInfo) {
                        // 保存用户数据
                        userData = userInfo;
                        localStorage.setItem('dance_user_data', JSON.stringify(userInfo));

                        // 计算token过期时间（假设token有效期为7天）
                        const expireTime = new Date();
                        expireTime.setDate(expireTime.getDate() + 7);
                        localStorage.setItem('dance_user_token', JSON.stringify({
                            token: token,
                            expireTime: expireTime.toISOString()
                        }));

                        // 显示用户信息
                        showUserInfo(userInfo);

                        // 3秒后关闭登录框
                        setTimeout(() => {
                            closeLoginModal();
                        }, 3000);
                    }

                } else {
                    loginStatus.textContent = '等待确认...';
                    loginStatus.className = 'login-status scanned';
                }

            } catch (error) {
                console.error('检查登录状态失败:', error);
                loginStatus.textContent = '登录检查失败';
                loginStatus.className = 'login-status error';
            }
        }, 3000);
    }

    // 获取用户信息（需要根据实际API调整）
    async function getUserInfo(token) {
        try {
            // 这里需要调用实际的用户信息接口
            // 由于不知道具体的API，这里返回模拟数据
            return {
                userId: Math.floor(Math.random() * 1000000),
                nickname: '微信用户',
                avatar: null
            };
        } catch (error) {
            console.error('获取用户信息失败:', error);
            return null;
        }
    }

    // 打开登录模态框
    function openLoginModal() {
        loginModal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // 重置状态
        loginStatus.textContent = '请点击二维码区域生成二维码';
        loginStatus.className = 'login-status';
        loginExpireTime.style.display = 'none';
        loginQrcodeImg.style.display = 'none';
        loginQrPlaceholder.style.display = 'flex';

        // 如果之前有轮询，清除
        if (loginCheckInterval) {
            clearInterval(loginCheckInterval);
            loginCheckInterval = null;
        }
    }

    // 关闭登录模态框
    function closeLoginModal() {
        loginModal.classList.remove('active');
        document.body.style.overflow = 'auto';

        if (loginCheckInterval) {
            clearInterval(loginCheckInterval);
            loginCheckInterval = null;
        }
    }

    // 渲染工具卡片
    function renderTools(tools) {
        toolsGrid.innerHTML = '';

        tools.forEach(tool => {
            const toolCard = document.createElement('div');
            toolCard.className = 'tool-card';
            toolCard.dataset.id = tool.id;
            toolCard.dataset.category = tool.category;

            // 添加特色或新标签
            if (tool.featured) {
                toolCard.classList.add('featured');
            }
            if (tool.new) {
                toolCard.classList.add('new');
            }
            if (tool.second) {
                toolCard.classList.add('second');
            }
            if (tool.official) {
                toolCard.classList.add('official');
            }

            toolCard.innerHTML = `
                <div class="tool-header">
                    <div class="tool-icon" style="background: linear-gradient(135deg, ${tool.iconColor}99, ${tool.iconColor});">
                        <i class="${tool.icon}"></i>
                    </div>
                    <div class="tool-info">
                        <h3>${tool.name}</h3>
                        <p>${getCategoryName(tool.category)}</p>
                    </div>
                    ${tool.featured ? '<div class="tool-badge featured-badge">实用</div>' : ''}
                    ${tool.new ? '<div class="tool-badge new-badge">新</div>' : ''}
                    ${tool.second ? '<div class="tool-badge second-badge">更新</div>' : ''}
                    ${tool.official ? '<div class="tool-badge official-badge">官方</div>' : ''}
                </div>
                <div class="tool-description">
                    ${tool.description}
                </div>
                <div class="tool-footer">
                    <a href="${tool.url}" class="tool-action" data-id="${tool.id}" target="_blank">
                        打开工具
                    </a>
                </div>
            `;

            toolsGrid.appendChild(toolCard);
        });

        // 为所有工具卡片添加点击事件（查看详情）
        document.querySelectorAll('.tool-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // 如果点击的是打开工具按钮，则不触发详情查看
                if (e.target.classList.contains('tool-action') || e.target.closest('.tool-action')) {
                    return;
                }
                const toolId = parseInt(this.getAttribute('data-id'));
                openToolModal(toolId);
            });
        });
    }

    // 打开工具模态框
    function openToolModal(toolId) {
        const tool = toolsData.find(t => t.id === toolId);
        if (!tool) return;

        currentToolId = toolId;

        // 更新模态框内容
        document.getElementById('modalToolName').textContent = tool.name;
        document.getElementById('modalToolCategory').textContent = `${getCategoryName(tool.category)} · ${tool.featured ? '特色功能' : '标准功能'}`;
        document.getElementById('modalToolDescription').textContent = tool.description;
        document.getElementById('modalIcon').innerHTML = `<i class="${tool.icon}"></i>`;
        document.getElementById('modalIcon').style.background = `linear-gradient(135deg, ${tool.iconColor}99, ${tool.iconColor})`;

        // 更新功能列表
        const featuresContainer = document.getElementById('modalFeatures');
        featuresContainer.innerHTML = '';
        tool.features.forEach(feature => {
            const featureEl = document.createElement('div');
            featureEl.className = 'modal-feature';
            featureEl.innerHTML = `<i class="fas fa-check-circle"></i> <span>${feature}</span>`;
            featuresContainer.appendChild(featureEl);
        });

        // 更新打开工具按钮的链接
        openToolBtn.href = tool.url;
        openToolBtn.setAttribute('target', '_blank');

        // 显示模态框
        toolModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // 关闭工具模态框
    function closeToolModal() {
        toolModal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // 设置事件监听器
    function setupEventListeners() {
        // 搜索功能
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredTools = toolsData.filter(tool =>
                tool.name.toLowerCase().includes(searchTerm) ||
                tool.description.toLowerCase().includes(searchTerm) ||
                getCategoryName(tool.category).toLowerCase().includes(searchTerm)
            );
            renderTools(filteredTools);
        });

        // 模态框关闭按钮
        modalClose.addEventListener('click', function(e) {
            e.stopPropagation();
            closeToolModal();
        });

        // 点击模态框背景关闭
        toolModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeToolModal();
            }
        });

        // 登录按钮
        loginBtn.addEventListener('click', openLoginModal);

        // 登录模态框关闭按钮
        loginClose.addEventListener('click', closeLoginModal);

        // 点击登录模态框背景关闭
        loginModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeLoginModal();
            }
        });

        // 二维码区域点击事件
        loginQrPlaceholder.addEventListener('click', generateLoginQRCode);
        loginQrcodeImg.addEventListener('click', generateLoginQRCode);

        // 退出登录按钮
        logoutBtn.addEventListener('click', function() {
            if (confirm('确定要退出登录吗？')) {
                clearUserData();
            }
        });

        // 添加ESC键关闭模态框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (toolModal.classList.contains('active')) {
                    closeToolModal();
                }
                if (loginModal.classList.contains('active')) {
                    closeLoginModal();
                }
            }
        });
    }

    // 获取分类名称
    function getCategoryName(category) {
        const categoryNames = {
            'exchange': '转换工具',
            'cut': '剪裁工具',
            'make': '绘制工具',
            'upload': '上传工具',
            'download': '下载工具',
            'token': 'Token工具'
        };
        return categoryNames[category] || '其他工具';
    }

    // 初始化页面
    document.addEventListener('DOMContentLoaded', initPage);

    // 安全检查函数
    function setupSecurity() {
        // 禁用右键
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // 禁用选择文本
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });

        // 禁用拖拽图片
        document.addEventListener('dragstart', function(e) {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
        });

        // 禁用开发者工具快捷键
        document.addEventListener('keydown', function(e) {
            // 禁用F12
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
            // 禁用Ctrl+Shift+I
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                return false;
            }
            // 禁用Ctrl+Shift+J
            if (e.ctrlKey && e.shiftKey && e.key === 'J') {
                e.preventDefault();
                return false;
            }
            // 禁用Ctrl+U
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                return false;
            }
        });
    }

    // 设置安全措施
    setupSecurity();
</script>
</body>
</html>