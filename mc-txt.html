<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·è“è‰² MC/MCZ è½¬ TXT å·¥å…·</title>
    <style>
        /* å…¨å±€æ ·å¼ - æµ·è“è‰²ä¸»é¢˜ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ */
        :root {
            --ocean-deep: #0d2b4e;
            --ocean-medium: #1c4a7a;
            --ocean-light: #2a69a6;
            --ocean-bright: #3a8ad2;
            --wave-blue: #4ca6ff;
            --foam-white: #ffffff;
            --light-blue: #e8f4ff;
            --coral: #ff6b4a;
            --seagrass: #2e8b57;
            --dark-text: #0a1a2a;
            --light-text: #ffffff;
            --text-primary: #ffffff;
            --text-secondary: #c2e0ff;
            --text-tertiary: #8ac6ff;
            --level-a: #4CAF50; /* åŸºç¡€ */
            --level-b: #2196F3; /* è¿›é˜¶ */
            --level-c: #FF9800; /* ä¸“å®¶ */
            --level-d: #F44336; /* å¤§å¸ˆ */
            --level-e: #9C27B0; /* ä¼ å¥‡ */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c2d4d 0%, #1a3a5f 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(13, 43, 78, 0.92);
            border-radius: 20px;
            box-shadow:
                    0 15px 35px rgba(0, 30, 60, 0.5),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border: 1px solid rgba(76, 166, 255, 0.3);
            position: relative;
            z-index: 1;
        }

        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, var(--ocean-deep) 0%, var(--ocean-medium) 100%);
            color: white;
            padding: 35px 45px 25px;
            position: relative;
            border-bottom: 2px solid rgba(76, 166, 255, 0.3);
        }

        .header h1 {
            font-size: 38px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 20px;
            letter-spacing: 0.5px;
        }

        .header .icon {
            font-size: 44px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .header .subtitle {
            font-size: 17px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            max-width: 700px;
            line-height: 1.6;
            font-weight: 400;
        }

        .version {
            position: absolute;
            top: 30px;
            right: 40px;
            background: rgba(76, 166, 255, 0.2);
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(76, 166, 255, 0.4);
            color: var(--text-primary);
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            display: grid;
            grid-template-columns: 1.1fr 1.9fr;
            gap: 25px;
            padding: 35px;
            position: relative;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: rgba(28, 74, 122, 0.85);
            padding: 30px;
            border-radius: 18px;
            border: 1px solid rgba(76, 166, 255, 0.3);
            box-shadow:
                    inset 0 2px 4px rgba(0, 0, 0, 0.1),
                    0 8px 25px rgba(0, 30, 60, 0.3);
        }

        .control-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 19px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(76, 166, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.3px;
        }

        .section-title i {
            font-size: 22px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .file-upload {
            border: 3px dashed rgba(76, 166, 255, 0.4);
            border-radius: 16px;
            padding: 35px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(13, 43, 78, 0.6);
            position: relative;
            overflow: hidden;
        }

        .file-upload:hover {
            border-color: var(--wave-blue);
            background: rgba(28, 74, 122, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 60, 120, 0.3);
        }

        .file-upload.dragover {
            border-color: var(--coral);
            background: rgba(255, 107, 74, 0.1);
        }

        .upload-icon {
            font-size: 42px;
            color: var(--wave-blue);
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .file-upload p {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .file-upload .hint {
            font-size: 13px;
            color: var(--text-tertiary);
            opacity: 0.9;
        }

        .file-info {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-primary);
            word-break: break-all;
            padding: 10px;
            background: rgba(13, 43, 78, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(76, 166, 255, 0.3);
            transition: all 0.3s;
            font-weight: 500;
        }

        .file-info.highlight {
            color: var(--wave-blue);
            border-color: var(--wave-blue);
        }

        /* é¢å¤–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .extra-files {
            margin-top: 15px;
            display: none;
        }

        .extra-files.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .extra-file-upload {
            border: 2px dashed rgba(76, 166, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(13, 43, 78, 0.5);
        }

        .extra-file-upload:hover {
            border-color: var(--wave-blue);
            background: rgba(28, 74, 122, 0.4);
        }

        .extra-file-upload input {
            display: none;
        }

        .extra-file-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .extra-file-label .icon {
            font-size: 18px;
        }

        .extra-file-preview {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 5px;
            word-break: break-all;
        }

        /* ç­‰çº§é€‰æ‹©åŒºåŸŸ */
        .level-selection {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .level-btn {
            padding: 12px 8px;
            border: 2px solid rgba(76, 166, 255, 0.3);
            border-radius: 10px;
            background: rgba(13, 43, 78, 0.6);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .level-btn:hover {
            transform: translateY(-2px);
            border-color: var(--wave-blue);
        }

        .level-btn.active {
            color: white;
            border-color: currentColor;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .level-btn.level-a.active { background: var(--level-a); color: white; }
        .level-btn.level-b.active { background: var(--level-b); color: white; }
        .level-btn.level-c.active { background: var(--level-c); color: white; }
        .level-btn.level-d.active { background: var(--level-d); color: white; }
        .level-btn.level-e.active { background: var(--level-e); color: white; }

        .level-btn .level-letter {
            font-size: 18px;
            font-weight: 800;
        }

        .level-btn .level-name {
            font-size: 12px;
            opacity: 0.9;
        }

        /* ç­‰çº§æ•°å­—è¾“å…¥ */
        .level-number-input {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .level-number-input label {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 600;
            white-space: nowrap;
        }

        .level-number-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(76, 166, 255, 0.3);
            border-radius: 10px;
            background: rgba(13, 43, 78, 0.6);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            outline: none;
            transition: all 0.3s;
        }

        .level-number-input input:focus {
            border-color: var(--wave-blue);
            box-shadow: 0 0 0 3px rgba(76, 166, 255, 0.2);
        }

        .level-number-input input::placeholder {
            color: var(--text-tertiary);
            opacity: 0.7;
        }

        /* æ–‡ä»¶é€‰æ‹©å™¨ï¼ˆMCZå†…éƒ¨æ–‡ä»¶ï¼‰ */
        .file-selector {
            margin-top: 15px;
            display: none;
        }

        .file-selector.active {
            display: block;
        }

        .file-selector select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(76, 166, 255, 0.3);
            border-radius: 10px;
            background: rgba(13, 43, 78, 0.8);
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            outline: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-selector select:hover {
            border-color: var(--wave-blue);
        }

        .file-selector select:focus {
            border-color: var(--wave-blue);
            box-shadow: 0 0 0 3px rgba(76, 166, 255, 0.2);
        }

        /* å¤é€‰æ¡†æ ·å¼ */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            background: rgba(13, 43, 78, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(76, 166, 255, 0.3);
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .checkbox-group:hover {
            background: rgba(28, 74, 122, 0.5);
            border-color: var(--wave-blue);
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--wave-blue);
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 16px;
            color: var(--text-primary);
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 28px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--wave-blue) 100%);
            box-shadow: 0 6px 20px rgba(58, 105, 162, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--wave-blue) 0%, var(--ocean-bright) 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76, 166, 255, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--seagrass) 0%, #3cb371 100%);
            box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #3cb371 0%, #4cd984 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76, 217, 132, 0.5);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--level-c) 0%, #ffb74d 100%);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffb74d 0%, #ffcc80 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 183, 77, 0.5);
        }

        .btn-secondary {
            background: rgba(28, 74, 122, 0.7);
            border: 2px solid rgba(76, 166, 255, 0.5);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(58, 122, 181, 0.5);
            border-color: var(--wave-blue);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 60, 120, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: rgba(13, 43, 78, 0.7);
            padding: 18px;
            border-radius: 12px;
            border: 1px solid rgba(76, 166, 255, 0.2);
        }

        .stat-item h4 {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-item .value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-item .unit {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-left: 4px;
            font-weight: 500;
        }

        /* å³ä¾§ç»“æœé¢æ¿ */
        .result-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* ä¿¡æ¯å¡ç‰‡ */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
        }

        @media (max-width: 1200px) {
            .info-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .info-cards {
                grid-template-columns: 1fr;
            }
        }

        .info-card {
            background: linear-gradient(135deg, rgba(28, 74, 122, 0.8) 0%, rgba(58, 122, 181, 0.8) 100%);
            padding: 22px;
            border-radius: 16px;
            border: 1px solid rgba(76, 166, 255, 0.3);
            box-shadow: 0 8px 20px rgba(0, 30, 60, 0.3);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 60, 120, 0.4);
            border-color: rgba(76, 166, 255, 0.6);
        }

        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--wave-blue), var(--ocean-bright));
        }

        .info-card h3 {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .info-card .value {
            font-size: 34px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .info-card .unit {
            font-size: 15px;
            color: var(--text-tertiary);
            margin-left: 8px;
            font-weight: 600;
        }

        /* BPM è¡¨æ ¼ */
        .bpm-table-container {
            background: rgba(28, 74, 122, 0.7);
            border-radius: 16px;
            border: 1px solid rgba(76, 166, 255, 0.3);
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 30, 60, 0.3);
        }

        .bpm-table-header {
            background: linear-gradient(90deg, var(--ocean-medium), var(--ocean-light));
            padding: 18px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(76, 166, 255, 0.3);
        }

        .bpm-table-header h3 {
            font-size: 19px;
            color: var(--text-primary);
            font-weight: 700;
        }

        .bpm-table-header span {
            background: rgba(13, 43, 78, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(76, 166, 255, 0.4);
            color: var(--text-primary);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 280px;
            overflow-y: auto;
        }

        .table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(13, 43, 78, 0.3);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--wave-blue);
            border-radius: 4px;
        }

        .bpm-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .bpm-table th {
            background: rgba(58, 122, 181, 0.9);
            color: var(--text-primary);
            font-weight: 700;
            padding: 16px 18px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid rgba(76, 166, 255, 0.5);
            font-size: 15px;
        }

        .bpm-table td {
            padding: 14px 18px;
            border-bottom: 1px solid rgba(76, 166, 255, 0.2);
            color: var(--text-primary);
            font-weight: 500;
        }

        .bpm-table tr:hover {
            background: rgba(76, 166, 255, 0.15);
        }

        .bpm-table tr:nth-child(even) {
            background: rgba(13, 43, 78, 0.4);
        }

        .bpm-table tr:nth-child(even):hover {
            background: rgba(76, 166, 255, 0.2);
        }

        /* è¾“å‡ºåŒºåŸŸ */
        .output-container {
            background: rgba(28, 74, 122, 0.7);
            border-radius: 16px;
            border: 1px solid rgba(76, 166, 255, 0.3);
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 30, 60, 0.3);
        }

        .output-tabs {
            display: flex;
            background: linear-gradient(90deg, var(--ocean-medium), var(--ocean-light));
            border-bottom: 1px solid rgba(76, 166, 255, 0.3);
        }

        .tab-btn {
            padding: 16px 28px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-btn.active {
            color: var(--text-primary);
            background: rgba(13, 43, 78, 0.4);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--wave-blue);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(13, 43, 78, 0.2);
        }

        .tab-content {
            display: none;
            height: 300px;
        }

        .tab-content.active {
            display: block;
        }

        .output-textarea {
            width: 100%;
            height: 100%;
            padding: 22px;
            border: none;
            background: rgba(13, 43, 78, 0.8);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            color: var(--text-primary);
            outline: none;
        }

        .output-textarea::-webkit-scrollbar {
            width: 10px;
        }

        .output-textarea::-webkit-scrollbar-track {
            background: rgba(13, 43, 78, 0.3);
        }

        .output-textarea::-webkit-scrollbar-thumb {
            background: var(--wave-blue);
            border-radius: 5px;
        }

        .output-textarea::-webkit-scrollbar-thumb:hover {
            background: var(--ocean-bright);
        }

        .output-textarea:read-only {
            color: var(--text-primary);
        }

        /* çŠ¶æ€æç¤º */
        .status-message {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 26px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(28, 74, 122, 0.95) 0%, rgba(58, 122, 181, 0.95) 100%);
            box-shadow: 0 10px 30px rgba(0, 30, 60, 0.5);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            border: 1px solid rgba(76, 166, 255, 0.4);
            max-width: 380px;
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-message.success {
            border-left: 5px solid var(--seagrass);
        }

        .status-message.error {
            border-left: 5px solid var(--coral);
        }

        .status-message.info {
            border-left: 5px solid var(--wave-blue);
        }

        .status-message .icon {
            font-size: 22px;
            flex-shrink: 0;
        }

        .status-message .message {
            font-size: 15px;
            font-weight: 600;
            line-height: 1.4;
            color: var(--text-primary);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* è„‰å†²åŠ¨ç”» */
        .pulse {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(76, 166, 255, 0.4);
            }
            50% {
                box-shadow: 0 6px 30px rgba(76, 166, 255, 0.7);
            }
        }

        /* æ–‡æœ¬å¢å¼º */
        .text-bold {
            font-weight: 700;
        }

        .text-bolder {
            font-weight: 800;
        }

        .text-highlight {
            color: var(--wave-blue) !important;
        }

        .text-white {
            color: var(--text-primary) !important;
        }

        /* æ–‡ä»¶åé¢„è§ˆ */
        .filename-preview {
            margin-top: 15px;
            padding: 12px;
            background: rgba(13, 43, 78, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(76, 166, 255, 0.3);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .filename-preview .preview-text {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 5px;
            word-break: break-all;
        }

        /* ç­‰çº§å¾½ç«  */
        .level-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 12px;
            margin-left: 8px;
            color: white;
        }

        .level-badge.level-a { background: var(--level-a); }
        .level-badge.level-b { background: var(--level-b); }
        .level-badge.level-c { background: var(--level-c); }
        .level-badge.level-d { background: var(--level-d); }
        .level-badge.level-e { background: var(--level-e); }

        /* è§£å‹è¿›åº¦æ¡ */
        .extract-progress {
            width: 100%;
            height: 4px;
            background: rgba(13, 43, 78, 0.3);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }

        .extract-progress.active {
            display: block;
        }

        .extract-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--wave-blue), var(--ocean-bright));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* æ–‡ä»¶é¢„è§ˆåˆ—è¡¨ */
        .file-preview-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(13, 43, 78, 0.5);
            border-radius: 8px;
            padding: 10px;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: rgba(28, 74, 122, 0.3);
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .file-preview-item:last-child {
            margin-bottom: 0;
        }

        .file-preview-name {
            flex: 1;
            word-break: break-all;
            color: var(--text-primary);
        }

        .file-preview-size {
            margin-left: 10px;
            color: var(--text-tertiary);
            font-weight: 600;
        }

        .file-preview-remove {
            margin-left: 10px;
            background: rgba(244, 67, 54, 0.3);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-remove:hover {
            background: rgba(244, 67, 54, 0.5);
        }

        /* è“è‰²ç½®é¡¶è¿”å›æŒ‰é’® */
        .back-home-btn {
            position: fixed;
            top: 20px; /* ç½®é¡¶ */
            right: 30px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #1e90ff, #0066cc); /* è“è‰²æ¸å˜ */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            box-shadow:
                    0 6px 20px rgba(30, 144, 255, 0.4),
                    inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            opacity: 0;
            animation: slideInFromTop 0.5s ease forwards;
            animation-delay: 0.3s;
        }

        /* ä»ä¸Šå‘ä¸‹æ»‘å…¥åŠ¨ç”» */
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .back-home-btn:hover {
            transform: translateY(-2px) scale(1.08);
            box-shadow:
                    0 10px 30px rgba(30, 144, 255, 0.5),
                    0 0 0 4px rgba(30, 144, 255, 0.1),
                    inset 0 2px 4px rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #00bfff, #0059b3); /* æ›´äº®çš„è“è‰² */
        }

        .back-home-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow:
                    0 3px 10px rgba(30, 144, 255, 0.3),
                    inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .back-home-btn .material-icons {
            color: white;
            font-size: 26px;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .back-home-btn:hover .material-icons {
            transform: translateX(-2px);
        }

        /* æ·»åŠ å‘å…‰æ•ˆæœ */
        .back-home-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(135deg,
            rgba(255, 255, 255, 0.1) 0%,
            rgba(255, 255, 255, 0) 50%,
            rgba(0, 0, 0, 0.1) 100%);
            pointer-events: none;
        }

        /* æ·»åŠ è¿”å›æ–‡å­—æç¤ºï¼ˆæ‚¬åœæ—¶æ˜¾ç¤ºï¼‰ */
        .back-home-btn::after {
            content: 'è¿”å›é¦–é¡µ';
            position: absolute;
            top: 65px;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-home-btn:hover::after {
            opacity: 1;
            transform: translateY(0);
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .back-home-btn {
                top: 15px;
                right: 20px;
                width: 48px;
                height: 48px;
            }

            .back-home-btn .material-icons {
                font-size: 22px;
            }

            .back-home-btn::after {
                font-size: 11px;
                padding: 5px 10px;
            }
        }

        /* æ‰‹æœºæ¨ªå±é€‚é… */
        @media (max-width: 768px) and (orientation: landscape) {
            .back-home-btn {
                top: 10px;
                right: 15px;
                width: 44px;
                height: 44px;
            }

            .back-home-btn .material-icons {
                font-size: 20px;
            }
        }

        /* è¶…å°å±å¹• */
        @media (max-width: 480px) {
            .back-home-btn {
                width: 44px;
                height: 44px;
                top: 12px;
                right: 15px;
            }

            .back-home-btn .material-icons {
                font-size: 20px;
            }
        }

    </style>
</head>
<body>

<div class="back-home-btn" onclick="window.location.href='../index.html'">
    <span class="material-icons">â†</span>
</div>

<!-- ä¸»å®¹å™¨ -->
<div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>
            MC/MCZ è½¬ TXT å·¥å…·
        </h1>
        <div class="subtitle">æ”¯æŒ MC å’Œ MCZ æ–‡ä»¶ï¼Œè‡ªåŠ¨æå–å†…éƒ¨æ–‡ä»¶ï¼Œæ‰“åŒ…ä¸‹è½½</div>
        <div class="version">v2.0</div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="control-section">
                <h3 class="section-title">
                    <span class="icon">ğŸ“</span>
                    æ–‡ä»¶ä¸Šä¼ 
                </h3>
                <div class="file-upload" id="fileDropArea">
                    <div class="upload-icon">ğŸ“¤</div>
                    <p class="text-bold">æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <p class="hint">æ”¯æŒ .mc å’Œ .mcz æ ¼å¼æ–‡ä»¶</p>
                    <div class="file-info" id="fileInfo">ç­‰å¾…æ–‡ä»¶é€‰æ‹©...</div>
                    <div class="extract-progress" id="extractProgress">
                        <div class="extract-progress-bar" id="extractProgressBar"></div>
                    </div>
                    <input type="file" id="fileInput" accept=".mc,.mcz" style="display: none;">
                </div>

                <!-- é¢å¤–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸï¼ˆä»…MCæ–‡ä»¶æ˜¾ç¤ºï¼‰ -->
                <div class="extra-files" id="extraFiles">
                    <div class="extra-file-upload" id="audioUpload" style="margin-bottom: 15px;">
                        <input type="file" id="audioInput" accept=".mp3,.wav,.ogg,.flac,.m4a,.aac">
                        <div class="extra-file-label">
                            <span class="icon">ğŸµ</span>
                            <span>ç‚¹å‡»ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</span>
                        </div>
                        <div class="extra-file-preview" id="audioPreview"></div>
                    </div>

                    <div class="extra-file-upload" id="imageUpload" style="margin-bottom: 15px;">
                        <input type="file" id="imageInput" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp">
                        <div class="extra-file-label">
                            <span class="icon">ğŸ–¼ï¸</span>
                            <span>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶</span>
                        </div>
                        <div class="extra-file-preview" id="imagePreview"></div>
                    </div>

                    <div class="file-preview-list" id="extraFilesList">
                        <div class="file-preview-item">
                            <div class="file-preview-name">æš‚æ— é¢å¤–æ–‡ä»¶</div>
                        </div>
                    </div>
                </div>

                <div class="file-selector" id="fileSelector">
                    <select id="internalFileSelect">
                        <option value="">è¯·é€‰æ‹©è¦è½¬æ¢çš„ MC æ–‡ä»¶...</option>
                    </select>
                    <div class="file-preview-list" id="mczFilesList"></div>
                </div>
            </div>

            <!-- ç­‰çº§é€‰æ‹©åŒºåŸŸ -->
            <div class="control-section">
                <h3 class="section-title">
                    <span class="icon">ğŸ†</span>
                    ç­‰çº§åˆ†ç±»
                </h3>
                <div class="level-selection">
                    <button class="level-btn level-a" data-level="A" data-name="åŸºç¡€">
                        <span class="level-letter">A</span>
                        <span class="level-name">åŸºç¡€</span>
                    </button>
                    <button class="level-btn level-b" data-level="B" data-name="è¿›é˜¶">
                        <span class="level-letter">B</span>
                        <span class="level-name">è¿›é˜¶</span>
                    </button>
                    <button class="level-btn level-c" data-level="C" data-name="ä¸“å®¶">
                        <span class="level-letter">C</span>
                        <span class="level-name">ä¸“å®¶</span>
                    </button>
                    <button class="level-btn level-d" data-level="D" data-name="å¤§å¸ˆ">
                        <span class="level-letter">D</span>
                        <span class="level-name">å¤§å¸ˆ</span>
                    </button>
                    <button class="level-btn level-e" data-level="E" data-name="ä¼ å¥‡">
                        <span class="level-letter">E</span>
                        <span class="level-name">ä¼ å¥‡</span>
                    </button>
                </div>
                <div class="level-number-input">
                    <label for="levelNumber">ç­‰çº§æ•°å­—ï¼š</label>
                    <input type="number" id="levelNumber" min="1" max="999" placeholder="ä¾‹å¦‚: 18" value="1">
                </div>
                <div class="filename-preview">
                    <div>è¾“å‡ºæ–‡ä»¶åé¢„è§ˆï¼š</div>
                    <div class="preview-text" id="filenamePreview">æœªé€‰æ‹©ç­‰çº§</div>
                </div>
            </div>

            <!-- è½¬æ¢é€‰é¡¹ -->
            <div class="control-section">
                <h3 class="section-title">
                    <span class="icon">âš™ï¸</span>
                    è½¬æ¢é€‰é¡¹
                </h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="mergeCheckbox" checked>
                    <label for="mergeCheckbox" class="text-bold">åˆå¹¶ç›¸åŒèŠ‚æ‹çš„éŸ³ç¬¦è½¨é“</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="autoDownload" checked>
                    <label for="autoDownload" class="text-bold">è½¬æ¢å®Œæˆåè‡ªåŠ¨ä¸‹è½½æ–‡ä»¶</label>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="control-section">
                <h3 class="section-title">
                    å¼€å§‹è½¬æ¢
                </h3>
                <button class="btn btn-primary" id="convertBtn">
                    <span class="icon">ğŸ”„</span>
                    <span class="text-bold">å¼€å§‹è½¬æ¢</span>
                </button>
                <button class="btn btn-success" id="downloadBtn" disabled>
                    <span class="icon">ğŸ’¾</span>
                    <span class="text-bold">ä¸‹è½½TXTæ–‡ä»¶</span>
                </button>
                <button class="btn btn-warning" id="zipBtn" disabled>
                    <span class="icon">ğŸ“¦</span>
                    <span class="text-bold">æ‰“åŒ…ä¸‹è½½ZIP</span>
                </button>
                <button class="btn btn-secondary" id="resetBtn">
                    <span class="icon">ğŸ—‘ï¸</span>
                    <span class="text-bold">é‡ç½®æ‰€æœ‰</span>
                </button>
                <button class="btn btn-secondary" id="forceResetBtn" style="background: rgba(244, 67, 54, 0.3); border-color: rgba(244, 67, 54, 0.5);">
                    <span class="icon">ğŸ”„</span>
                    <span class="text-bold">å¼ºåˆ¶é‡ç½®è§£å‹å™¨</span>
                </button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="control-section">
                <h3 class="section-title">
                    <span class="icon">ğŸ“Š</span>
                    è½¬æ¢ç»Ÿè®¡
                </h3>
                <div id="statsInfo" class="stats-grid">
                    <div class="stat-item">
                        <h4>æ–‡ä»¶å¤§å°</h4>
                        <div class="value" id="fileSize">--</div>
                        <span class="unit">KB</span>
                    </div>
                    <div class="stat-item">
                        <h4>è½¬æ¢è€—æ—¶</h4>
                        <div class="value" id="convertTime">--</div>
                        <span class="unit">ms</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ç»“æœé¢æ¿ -->
        <div class="result-panel">
            <!-- å…³é”®ä¿¡æ¯å¡ç‰‡ -->
            <div class="info-cards" id="infoCards">
                <div class="info-card">
                    <h3>åŸºå‡† BPM</h3>
                    <div class="value text-bolder" id="baseBPM">--</div>
                    <span class="unit">BPM</span>
                </div>
                <div class="info-card">
                    <h3>åç§»æ—¶é—´</h3>
                    <div class="value text-bolder" id="offsetValue">--</div>
                    <span class="unit">ms</span>
                </div>
                <div class="info-card">
                    <h3>èµ·å§‹æ—¶é—´</h3>
                    <div class="value text-bolder" id="startTime">--</div>
                    <span class="unit">ç§’</span>
                </div>
                <div class="info-card">
                    <h3>éŸ³ç¬¦æ•°é‡</h3>
                    <div class="value text-bolder" id="noteCount">--</div>
                    <span class="unit">ä¸ª</span>
                </div>
            </div>

            <!-- BPM å˜åŒ–è¡¨æ ¼ -->
            <div class="bpm-table-container">
                <div class="bpm-table-header">
                    <h3>BPM å˜åŒ–åŒºé—´</h3>
                    <span id="bpmCount">0 ä¸ªåŒºé—´</span>
                </div>
                <div class="table-wrapper">
                    <table class="bpm-table" id="bpmTable">
                        <thead>
                        <tr>
                            <th>æ®µåºå·</th>
                            <th>èµ·å§‹ Beat</th>
                            <th>BPM</th>
                            <th>æŒç»­èŠ‚æ‹</th>
                        </tr>
                        </thead>
                        <tbody id="bpmTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 50px; color: var(--text-tertiary);">
                                <div style="font-size: 40px; margin-bottom: 20px;">ğŸ“Š</div>
                                <div class="text-bold">é€‰æ‹©æ–‡ä»¶å¹¶å¼€å§‹è½¬æ¢åï¼ŒBPM æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è¾“å‡ºç»“æœé€‰é¡¹å¡ -->
            <div class="output-container">
                <div class="output-tabs">
                    <button class="tab-btn active" data-tab="normal">
                        <span class="icon">ğŸµ</span>
                        <span class="text-bold">æ™®é€šéŸ³ç¬¦ TXT</span>
                    </button>
                    <button class="tab-btn" data-tab="sv">
                        <span class="icon">ğŸ“ˆ</span>
                        <span class="text-bold">æ»šåŠ¨é€Ÿåº¦ TXT</span>
                    </button>
                    <button class="tab-btn" data-tab="raw">
                        <span class="icon">ğŸ“„</span>
                        <span class="text-bold">åŸå§‹æ•°æ®</span>
                    </button>
                    <button class="tab-btn" data-tab="info">
                        <span class="icon">ğŸ“‹</span>
                        <span class="text-bold">ä¿¡æ¯æ–‡ä»¶</span>
                    </button>
                </div>
                <div class="tab-content active" id="tab-normal">
                    <textarea class="output-textarea text-bold" id="outputNormal" readonly placeholder="è½¬æ¢åçš„æ™®é€šéŸ³ç¬¦ TXT å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                </div>
                <div class="tab-content" id="tab-sv">
                    <textarea class="output-textarea text-bold" id="outputSV" readonly placeholder="SV æ»šåŠ¨é€Ÿåº¦æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                </div>
                <div class="tab-content" id="tab-raw">
                    <textarea class="output-textarea text-bold" id="outputRaw" readonly placeholder="åŸå§‹ JSON æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                </div>
                <div class="tab-content" id="tab-info">
                    <textarea class="output-textarea text-bold" id="outputInfo" readonly placeholder="ä¸Šä¼ ä¿¡æ¯.txt å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288&#12288  æœ¬é‡‡ç”¨ æ±Ÿç¥ˆè¨€çš„txt-mcæ–‡ä»¶ è¿›è¡Œå¼€å‘ | ç”± Mouseke è¿›è¡Œå¢åŠ åŠŸèƒ½ </p>
    </footer>

</div>



<!-- çŠ¶æ€æç¤º -->
<div class="status-message" id="statusMessage">
    <div class="icon">â„¹ï¸</div>
    <div class="message">çŠ¶æ€æç¤º</div>
</div>



<script>
    // å…¨å±€å˜é‡
    let globalNormalLines = null;
    let globalEffectLines = null;
    let globalFileName = "";
    let globalJsonData = null;
    let globalTimeList = null;
    let conversionStartTime = 0;
    let isMCZFile = false;
    let mczFiles = [];
    let selectedLevel = "A";
    let selectedLevelName = "åŸºç¡€";
    let currentZipInstance = null;
    let isExtracting = false;

    // å­˜å‚¨é¢å¤–æ–‡ä»¶
    let extraAudioFile = null;
    let extraImageFile = null;
    let mczAudioFile = null;
    let mczImageFile = null;

    // ä» MC æ–‡ä»¶ä¸­æå–çš„å…ƒæ•°æ®
    let mcMetadata = {
        title: "",
        artist: "",
        bpm: 0,
        offset: 0,
        startTime: 0
    };

    // DOM å…ƒç´ 
    const fileInput = document.getElementById('fileInput');
    const fileDropArea = document.getElementById('fileDropArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileSelector = document.getElementById('fileSelector');
    const internalFileSelect = document.getElementById('internalFileSelect');
    const convertBtn = document.getElementById('convertBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const zipBtn = document.getElementById('zipBtn');
    const resetBtn = document.getElementById('resetBtn');
    const forceResetBtn = document.getElementById('forceResetBtn');
    const mergeCheckbox = document.getElementById('mergeCheckbox');
    const levelNumberInput = document.getElementById('levelNumber');
    const filenamePreview = document.getElementById('filenamePreview');
    const statusMessage = document.getElementById('statusMessage');
    const levelButtons = document.querySelectorAll('.level-btn');
    const extractProgress = document.getElementById('extractProgress');
    const extractProgressBar = document.getElementById('extractProgressBar');
    const extraFilesArea = document.getElementById('extraFiles');
    const audioInput = document.getElementById('audioInput');
    const imageInput = document.getElementById('imageInput');
    const audioPreview = document.getElementById('audioPreview');
    const imagePreview = document.getElementById('imagePreview');
    const extraFilesList = document.getElementById('extraFilesList');
    const mczFilesList = document.getElementById('mczFilesList');

    // æ¸…ç† zip å®ä¾‹
    function cleanupZipInstance() {
        if (currentZipInstance) {
            try {
                if (typeof currentZipInstance.cleanup === 'function') {
                    currentZipInstance.cleanup();
                }
                currentZipInstance = null;
            } catch (e) {
                console.log('æ¸…ç† zip å®ä¾‹æ—¶å‡ºé”™:', e);
                currentZipInstance = null;
            }
        }
        mczFiles = [];
        isExtracting = false;
    }

    // å¼ºåˆ¶é‡ç½®è§£å‹å™¨
    function forceResetExtractor() {
        cleanupZipInstance();

        // æ¸…é™¤æ‰€æœ‰ä¸ MCZ ç›¸å…³çš„çŠ¶æ€
        mczFiles = [];
        currentZipInstance = null;
        isExtracting = false;
        mczAudioFile = null;
        mczImageFile = null;

        // é‡ç½® UI
        fileSelector.classList.remove('active');
        internalFileSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦è½¬æ¢çš„ MC æ–‡ä»¶...</option>';
        mczFilesList.innerHTML = '';
        extractProgress.classList.remove('active');
        extractProgressBar.style.width = '0%';

        showStatus('è§£å‹å™¨å·²å¼ºåˆ¶é‡ç½®ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶', 'info');
    }

    // åˆå§‹åŒ–ç­‰çº§é€‰æ‹©
    function initLevelSelection() {
        levelButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                levelButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedLevel = this.dataset.level;
                selectedLevelName = this.dataset.name;
                updateFilenamePreview();
            });
        });

        document.querySelector('.level-btn.level-a').click();
    }

    // æ›´æ–°æ–‡ä»¶åé¢„è§ˆ
    function updateFilenamePreview() {
        const levelNum = levelNumberInput.value || "1";
        const paddedNum = levelNum.padStart(3, '0');
        const filename = `${selectedLevel}${paddedNum}.txt`;

        filenamePreview.innerHTML = '';

        const badge = document.createElement('span');
        badge.className = `level-badge level-${selectedLevel.toLowerCase()}`;
        badge.textContent = `${selectedLevelName} ${levelNum}`;

        const filenameSpan = document.createElement('span');
        filenameSpan.textContent = ` â†’ ${filename}`;
        filenameSpan.style.marginLeft = '10px';
        filenameSpan.style.fontWeight = '700';
        filenameSpan.style.color = 'var(--wave-blue)';

        filenamePreview.appendChild(badge);
        filenamePreview.appendChild(filenameSpan);
    }

    // æ˜¾ç¤ºçŠ¶æ€æç¤º
    function showStatus(message, type = 'info') {
        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            info: 'â„¹ï¸',
            warning: 'âš ï¸'
        };

        statusMessage.querySelector('.icon').textContent = icons[type];
        statusMessage.querySelector('.message').textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusMessage.classList.add('show');

        setTimeout(() => {
            statusMessage.classList.remove('show');
        }, 3500);
    }

    // æ›´æ–°è§£å‹è¿›åº¦
    function updateExtractProgress(percent) {
        extractProgressBar.style.width = `${percent}%`;
        if (percent > 0 && percent < 100) {
            extractProgress.classList.add('active');
        } else {
            setTimeout(() => {
                extractProgress.classList.remove('active');
                extractProgressBar.style.width = '0%';
            }, 500);
        }
    }

    // è§£å‹ MCZ æ–‡ä»¶
    async function extractMCZFile(file) {
        if (isExtracting) {
            showStatus('æ­£åœ¨è§£å‹ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
            return null;
        }

        try {
            isExtracting = true;
            updateExtractProgress(10);

            cleanupZipInstance();

            if (!window.JSZip) {
                updateExtractProgress(20);
                await loadJSZip();
            }

            updateExtractProgress(30);
            const zip = new JSZip();
            currentZipInstance = zip;

            showStatus('æ­£åœ¨è¯»å– MCZ æ–‡ä»¶...', 'info');

            const arrayBuffer = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });

            updateExtractProgress(50);
            showStatus('æ­£åœ¨è§£æ ZIP æ–‡ä»¶...', 'info');

            let zipData;
            try {
                zipData = await zip.loadAsync(arrayBuffer, {
                    checkCRC32: true,
                    optimizedBinaryString: true,
                    createFolders: false
                });
            } catch (zipError) {
                throw new Error(`ZIP æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ”¯æŒ: ${zipError.message}`);
            }

            updateExtractProgress(70);
            showStatus('æ­£åœ¨æŸ¥æ‰¾æ–‡ä»¶...', 'info');

            // è·å–æ‰€æœ‰æ–‡ä»¶
            const allFiles = [];
            let fileCount = 0;
            let processedCount = 0;

            // å…ˆè®¡ç®—æ€»æ–‡ä»¶æ•°
            zipData.forEach((relativePath, zipEntry) => {
                if (!zipEntry.dir) {
                    fileCount++;
                }
            });

            // éå†æ‰€æœ‰æ–‡ä»¶
            for (const relativePath in zipData.files) {
                const zipEntry = zipData.files[relativePath];
                if (zipEntry.dir) continue;

                processedCount++;
                updateExtractProgress(70 + Math.floor((processedCount / fileCount) * 20));

                const fileName = relativePath.split('/').pop().toLowerCase();

                // åˆ†ç±»æ–‡ä»¶
                if (fileName.endsWith('.mc')) {
                    allFiles.push({
                        name: relativePath.split('/').pop(),
                        path: relativePath,
                        zipEntry: zipEntry,
                        size: zipEntry._data.uncompressedSize || 0,
                        type: 'mc'
                    });
                } else if (fileName.match(/\.(mp3|wav|ogg|flac|m4a|aac)$/)) {
                    allFiles.push({
                        name: relativePath.split('/').pop(),
                        path: relativePath,
                        zipEntry: zipEntry,
                        size: zipEntry._data.uncompressedSize || 0,
                        type: 'audio'
                    });
                } else if (fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)) {
                    allFiles.push({
                        name: relativePath.split('/').pop(),
                        path: relativePath,
                        zipEntry: zipEntry,
                        size: zipEntry._data.uncompressedSize || 0,
                        type: 'image'
                    });
                }
            }

            updateExtractProgress(95);

            // åˆ†ç¦»ä¸åŒç±»å‹çš„æ–‡ä»¶
            const mcFiles = allFiles.filter(f => f.type === 'mc');
            const audioFiles = allFiles.filter(f => f.type === 'audio');
            const imageFiles = allFiles.filter(f => f.type === 'image');

            if (mcFiles.length === 0) {
                throw new Error('MCZ æ–‡ä»¶ä¸­æœªæ‰¾åˆ° .mc æ–‡ä»¶');
            }

            mczFiles = mcFiles;

            // ä¿å­˜éŸ³é¢‘å’Œå›¾ç‰‡æ–‡ä»¶ï¼ˆå–ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ï¼‰
            if (audioFiles.length > 0) {
                mczAudioFile = audioFiles[0];
            }
            if (imageFiles.length > 0) {
                mczImageFile = imageFiles[0];
            }

            // æ›´æ–°æ–‡ä»¶é€‰æ‹©å™¨
            internalFileSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦è½¬æ¢çš„ MC æ–‡ä»¶...</option>';
            mcFiles.forEach((file, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
                internalFileSelect.appendChild(option);
            });

            // æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©å™¨
            fileSelector.classList.add('active');

            // æ˜¾ç¤ºæ‰¾åˆ°çš„æ‰€æœ‰æ–‡ä»¶
            updateMCZFilesList(allFiles);

            updateExtractProgress(100);
            showStatus(`MCZ æ–‡ä»¶è§£å‹å®Œæˆï¼Œæ‰¾åˆ° ${mcFiles.length} ä¸ª MC æ–‡ä»¶`, 'success');
            isExtracting = false;
            return mcFiles;

        } catch (error) {
            console.error('è§£å‹ MCZ æ–‡ä»¶å¤±è´¥:', error);
            showStatus(`è§£å‹ MCZ æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
            isExtracting = false;
            updateExtractProgress(0);

            cleanupZipInstance();
            fileSelector.classList.remove('active');
            internalFileSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦è½¬æ¢çš„ MC æ–‡ä»¶...</option>';
            mczFilesList.innerHTML = '';

            return null;
        }
    }

    // æ›´æ–°MCZæ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
    function updateMCZFilesList(files) {
        mczFilesList.innerHTML = '';

        if (files.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'file-preview-item';
            emptyMsg.textContent = 'æœªæ‰¾åˆ°æ–‡ä»¶';
            mczFilesList.appendChild(emptyMsg);
            return;
        }

        // æŒ‰ç±»å‹åˆ†ç»„
        const mcFiles = files.filter(f => f.type === 'mc');
        const audioFiles = files.filter(f => f.type === 'audio');
        const imageFiles = files.filter(f => f.type === 'image');

        // æ˜¾ç¤ºMCæ–‡ä»¶
        if (mcFiles.length > 0) {
            const header = document.createElement('div');
            header.className = 'file-preview-item';
            header.style.background = 'rgba(76, 175, 80, 0.2)';
            header.innerHTML = `<div class="file-preview-name">ğŸ“„ MCæ–‡ä»¶ (${mcFiles.length})</div>`;
            mczFilesList.appendChild(header);

            mcFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <div class="file-preview-name">${file.name}</div>
                    <div class="file-preview-size">${(file.size / 1024).toFixed(1)}KB</div>
                `;
                mczFilesList.appendChild(item);
            });
        }

        // æ˜¾ç¤ºéŸ³é¢‘æ–‡ä»¶
        if (audioFiles.length > 0) {
            const header = document.createElement('div');
            header.className = 'file-preview-item';
            header.style.background = 'rgba(33, 150, 243, 0.2)';
            header.innerHTML = `<div class="file-preview-name">ğŸµ éŸ³é¢‘æ–‡ä»¶ (${audioFiles.length})</div>`;
            mczFilesList.appendChild(header);

            audioFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <div class="file-preview-name">${file.name}</div>
                    <div class="file-preview-size">${(file.size / 1024).toFixed(1)}KB</div>
                `;
                mczFilesList.appendChild(item);
            });
        }

        // æ˜¾ç¤ºå›¾ç‰‡æ–‡ä»¶
        if (imageFiles.length > 0) {
            const header = document.createElement('div');
            header.className = 'file-preview-item';
            header.style.background = 'rgba(255, 152, 0, 0.2)';
            header.innerHTML = `<div class="file-preview-name">ğŸ–¼ï¸ å›¾ç‰‡æ–‡ä»¶ (${imageFiles.length})</div>`;
            mczFilesList.appendChild(header);

            imageFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <div class="file-preview-name">${file.name}</div>
                    <div class="file-preview-size">${(file.size / 1024).toFixed(1)}KB</div>
                `;
                mczFilesList.appendChild(item);
            });
        }
    }

    // åŠ¨æ€åŠ è½½ JSZip åº“
    function loadJSZip() {
        return new Promise((resolve, reject) => {
            if (window.JSZip) {
                resolve();
                return;
            }

            showStatus('æ­£åœ¨åŠ è½½è§£å‹åº“...', 'info');

            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.integrity = 'sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==';
            script.crossOrigin = 'anonymous';

            let timeoutId = setTimeout(() => {
                showStatus('è§£å‹åº“åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                reject(new Error('JSZip åŠ è½½è¶…æ—¶'));
            }, 10000);

            script.onload = () => {
                clearTimeout(timeoutId);
                if (window.JSZip) {
                    showStatus('è§£å‹åº“åŠ è½½å®Œæˆ', 'success');
                    resolve();
                } else {
                    showStatus('è§£å‹åº“åŠ è½½å¤±è´¥', 'error');
                    reject(new Error('JSZip åŠ è½½å¤±è´¥'));
                }
            };

            script.onerror = () => {
                clearTimeout(timeoutId);
                showStatus('åŠ è½½è§£å‹åº“å¤±è´¥ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸', 'error');
                reject(new Error('JSZip åŠ è½½å¤±è´¥'));
            };

            document.head.appendChild(script);
        });
    }

    // ä» MCZ æ–‡ä»¶ä¸­è¯»å–é€‰å®šçš„ MC æ–‡ä»¶
    async function readMCZFile(fileIndex) {
        try {
            const selectedFile = mczFiles[fileIndex];
            if (!selectedFile) {
                throw new Error('é€‰æ‹©çš„æ–‡ä»¶ä¸å­˜åœ¨');
            }

            showStatus(`æ­£åœ¨è¯»å–: ${selectedFile.name}...`, 'info');
            const content = await selectedFile.zipEntry.async('string');
            showStatus(`å·²è¯»å–: ${selectedFile.name}`, 'success');

            return {
                name: selectedFile.name,
                content: content
            };
        } catch (error) {
            console.error('è¯»å– MCZ å†…éƒ¨æ–‡ä»¶å¤±è´¥:', error);
            throw error;
        }
    }

    // ä» MCZ æ–‡ä»¶ä¸­æå–éŸ³é¢‘æˆ–å›¾ç‰‡æ–‡ä»¶
    async function extractMediaFileFromMCZ(file) {
        try {
            if (!file || !file.zipEntry) {
                return null;
            }

            const blob = await file.zipEntry.async('blob');
            return new File([blob], file.name, { type: blob.type });
        } catch (error) {
            console.error('æå–åª’ä½“æ–‡ä»¶å¤±è´¥:', error);
            return null;
        }
    }

    // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
    fileDropArea.addEventListener('click', () => fileInput.click());
    fileDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileDropArea.classList.add('dragover');
    });
    fileDropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileDropArea.classList.remove('dragover');
    });
    fileDropArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileDropArea.classList.remove('dragover');

        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            await updateFileInfo();
        }
    });

    // éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
    audioInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            extraAudioFile = this.files[0];
            audioPreview.textContent = `å·²é€‰æ‹©: ${extraAudioFile.name} (${(extraAudioFile.size / 1024).toFixed(1)}KB)`;
            showStatus(`å·²é€‰æ‹©éŸ³é¢‘æ–‡ä»¶: ${extraAudioFile.name}`, 'success');
            updateExtraFilesList();
        }
    });

    // å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ 
    imageInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            extraImageFile = this.files[0];
            imagePreview.textContent = `å·²é€‰æ‹©: ${extraImageFile.name} (${(extraImageFile.size / 1024).toFixed(1)}KB)`;
            showStatus(`å·²é€‰æ‹©å›¾ç‰‡æ–‡ä»¶: ${extraImageFile.name}`, 'success');
            updateExtraFilesList();
        }
    });

    // ç‚¹å‡»éŸ³é¢‘ä¸Šä¼ åŒºåŸŸ
    document.getElementById('audioUpload').addEventListener('click', function(e) {
        if (e.target !== audioInput) {
            audioInput.click();
        }
    });

    // ç‚¹å‡»å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ
    document.getElementById('imageUpload').addEventListener('click', function(e) {
        if (e.target !== imageInput) {
            imageInput.click();
        }
    });

    // æ›´æ–°é¢å¤–æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
    function updateExtraFilesList() {
        extraFilesList.innerHTML = '';
        const files = [];

        if (extraAudioFile) {
            files.push({
                name: extraAudioFile.name,
                size: extraAudioFile.size,
                type: 'audio'
            });
        }

        if (extraImageFile) {
            files.push({
                name: extraImageFile.name,
                size: extraImageFile.size,
                type: 'image'
            });
        }

        if (files.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'file-preview-item';
            emptyMsg.textContent = 'æš‚æ— é¢å¤–æ–‡ä»¶';
            extraFilesList.appendChild(emptyMsg);
            return;
        }

        files.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'file-preview-item';
            item.innerHTML = `
                <div class="file-preview-name">${file.type === 'audio' ? 'ğŸµ' : 'ğŸ–¼ï¸'} ${file.name}</div>
                <div class="file-preview-size">${(file.size / 1024).toFixed(1)}KB</div>
                <button class="file-preview-remove" data-index="${index}" data-type="${file.type}">Ã—</button>
            `;
            extraFilesList.appendChild(item);
        });

        // æ·»åŠ åˆ é™¤äº‹ä»¶
        extraFilesList.querySelectorAll('.file-preview-remove').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                if (type === 'audio') {
                    extraAudioFile = null;
                    audioInput.value = '';
                    audioPreview.textContent = '';
                } else if (type === 'image') {
                    extraImageFile = null;
                    imageInput.value = '';
                    imagePreview.textContent = '';
                }
                updateExtraFilesList();
                showStatus(`å·²ç§»é™¤${type === 'audio' ? 'éŸ³é¢‘' : 'å›¾ç‰‡'}æ–‡ä»¶`, 'info');
            });
        });
    }

    // MCZ å†…éƒ¨æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    internalFileSelect.addEventListener('change', function() {
        if (this.value !== "") {
            const selectedIndex = parseInt(this.value);
            const selectedFile = mczFiles[selectedIndex];
            if (selectedFile) {
                fileInfo.textContent = `å·²é€‰æ‹©: ${selectedFile.name} (${(selectedFile.size / 1024).toFixed(1)}KB)`;
                fileInfo.classList.add('highlight');
                convertBtn.disabled = false;
            }
        } else {
            fileInfo.textContent = `å·²ä¸Šä¼  MCZ æ–‡ä»¶: ${globalFileName}`;
            fileInfo.classList.remove('highlight');
            convertBtn.disabled = true;
        }
    });

    // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
    async function updateFileInfo() {
        if (fileInput.files.length) {
            const file = fileInput.files[0];
            globalFileName = file.name;
            isMCZFile = file.name.toLowerCase().endsWith('.mcz');

            // æ›´æ–°æ–‡ä»¶å¤§å°æ˜¾ç¤º
            const fileSizeKB = (file.size / 1024).toFixed(2);
            document.getElementById('fileSize').textContent = fileSizeKB;

            if (isMCZFile) {
                // å¤„ç† MCZ æ–‡ä»¶
                fileInfo.textContent = `å·²ä¸Šä¼  MCZ æ–‡ä»¶: ${file.name} (${fileSizeKB}KB)`;
                fileInfo.classList.add('highlight');

                // éšè—é¢å¤–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
                extraFilesArea.classList.remove('active');
                extraAudioFile = null;
                extraImageFile = null;
                updateExtraFilesList();

                // è§£å‹å¹¶æ˜¾ç¤ºå†…éƒ¨æ–‡ä»¶åˆ—è¡¨
                showStatus('æ­£åœ¨è§£å‹ MCZ æ–‡ä»¶...', 'info');
                convertBtn.disabled = true;
                downloadBtn.disabled = true;
                zipBtn.disabled = true;

                const result = await extractMCZFile(file);
                if (result) {
                    showStatus(`MCZ æ–‡ä»¶è§£å‹å®Œæˆï¼Œæ‰¾åˆ° ${result.length} ä¸ª MC æ–‡ä»¶`, 'success');
                } else {
                    showStatus('MCZ æ–‡ä»¶è§£å‹å¤±è´¥ï¼Œè¯·å°è¯•é‡ç½®è§£å‹å™¨æˆ–ä½¿ç”¨å…¶ä»–æ–‡ä»¶', 'error');
                }

            } else {
                // å¤„ç†æ™®é€š MC æ–‡ä»¶
                fileInfo.textContent = `å·²ä¸Šä¼  MC æ–‡ä»¶: ${file.name} (${fileSizeKB}KB)`;
                fileInfo.classList.remove('highlight');
                fileSelector.classList.remove('active');
                mczFilesList.innerHTML = '';

                // æ˜¾ç¤ºé¢å¤–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
                extraFilesArea.classList.add('active');

                convertBtn.disabled = false;
                showStatus(`å·²é€‰æ‹© MC æ–‡ä»¶: ${file.name} (${fileSizeKB}KB)`, 'success');

                // æ¸…ç©ºä¹‹å‰çš„é¢å¤–æ–‡ä»¶
                extraAudioFile = null;
                extraImageFile = null;
                audioInput.value = '';
                imageInput.value = '';
                audioPreview.textContent = '';
                imagePreview.textContent = '';
                updateExtraFilesList();
            }
        }
    }

    fileInput.addEventListener('change', updateFileInfo);

    // ç­‰çº§æ•°å­—è¾“å…¥äº‹ä»¶
    levelNumberInput.addEventListener('input', updateFilenamePreview);

    // å·¥å…·å‡½æ•°
    function beatArrayToFloat(arr) {
        return arr[0] + arr[1] / arr[2];
    }

    function convertBeat(beatVal, timeList, baseBPM) {
        let converted = 0;
        for (let i = 0; i < timeList.length; i++) {
            let segStart = beatArrayToFloat(timeList[i].beat);
            let segBPM = timeList[i].bpm;
            let segEnd = (i < timeList.length - 1) ? beatArrayToFloat(timeList[i+1].beat) : Infinity;
            if (beatVal >= segEnd) {
                let segLength = segEnd - segStart;
                converted += segLength * (baseBPM / segBPM);
            } else {
                let segLength = beatVal - segStart;
                converted += segLength * (baseBPM / segBPM);
                break;
            }
        }
        return converted;
    }

    function mergeLines(lines) {
        const groups = {};
        lines.forEach(line => {
            let parts = line.split("-");
            let key;
            if (parts.length === 2) {
                key = parts[1];
            } else if (parts.length === 3) {
                key = parts[1] + "-" + parts[2];
            }
            if (!groups[key]) {
                groups[key] = [];
            }
            groups[key].push(parseInt(parts[0]));
        });
        const merged = [];
        for (let key in groups) {
            let cols = groups[key];
            cols.sort((a, b) => b - a);
            let mergedCol = cols.join("");
            merged.push(mergedCol + "-" + key);
        }
        return merged;
    }

    // ä» MC æ–‡ä»¶ä¸­æå–å…ƒæ•°æ® - ä¿®å¤ç‰ˆæœ¬
    function extractMetadataFromMC(jsonData) {
        const metadata = {
            title: "",
            artist: "",
            bpm: 0,
            offset: 0,
            startTime: 0
        };

        console.log("=== MCæ–‡ä»¶æ•°æ®ç»“æ„åˆ†æ ===");
        console.log("å®Œæ•´çš„MCæ–‡ä»¶JSON:", jsonData);

        // æ–¹æ³•1: ç›´æ¥ä»é¡¶çº§è·å–
        if (jsonData.title) {
            metadata.title = jsonData.title;
            console.log("æ–¹æ³•1 - ä»é¡¶çº§è·å–title:", metadata.title);
        }

        if (jsonData.artist) {
            metadata.artist = jsonData.artist;
            console.log("æ–¹æ³•1 - ä»é¡¶çº§è·å–artist:", metadata.artist);
        }

        // æ–¹æ³•2: ä»metadataå¯¹è±¡è·å–
        if (!metadata.title && jsonData.metadata) {
            console.log("metadataå¯¹è±¡:", jsonData.metadata);

            if (jsonData.metadata.title) {
                metadata.title = jsonData.metadata.title;
                console.log("æ–¹æ³•2 - ä»metadataè·å–title:", metadata.title);
            }

            if (!metadata.artist && jsonData.metadata.artist) {
                metadata.artist = jsonData.metadata.artist;
                console.log("æ–¹æ³•2 - ä»metadataè·å–artist:", metadata.artist);
            }

            if (!metadata.artist && jsonData.metadata.author) {
                metadata.artist = jsonData.metadata.author;
                console.log("æ–¹æ³•2 - ä»metadataè·å–author:", metadata.artist);
            }
        }

        // æ–¹æ³•3: æœç´¢æ•´ä¸ªå¯¹è±¡æ ‘
        if (!metadata.title || !metadata.artist) {
            const found = deepSearchForMetadata(jsonData);
            if (!metadata.title && found.title) {
                metadata.title = found.title;
                console.log("æ–¹æ³•3 - æ·±åº¦æœç´¢æ‰¾åˆ°title:", metadata.title);
            }
            if (!metadata.artist && found.artist) {
                metadata.artist = found.artist;
                console.log("æ–¹æ³•3 - æ·±åº¦æœç´¢æ‰¾åˆ°artist:", metadata.artist);
            }
        }

        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°è¯•ä»æ–‡ä»¶åæå–
        if (!metadata.title && globalFileName) {
            const nameWithoutExt = globalFileName.replace(/\.mc$/i, '');
            metadata.title = nameWithoutExt;
            console.log("æ–¹æ³•4 - ä»æ–‡ä»¶åæå–title:", metadata.title);
        }

        // æœ€åä½¿ç”¨é»˜è®¤å€¼
        if (!metadata.title) {
            metadata.title = "æœªçŸ¥æ­Œæ›²";
            console.log("ä½¿ç”¨é»˜è®¤title:", metadata.title);
        }
        if (!metadata.artist) {
            metadata.artist = "æœªçŸ¥ä½œè€…";
            console.log("ä½¿ç”¨é»˜è®¤artist:", metadata.artist);
        }

        // æå– BPM
        if (globalTimeList && globalTimeList.length > 0) {
            metadata.bpm = globalTimeList[0].bpm;
            console.log("æå–BPM:", metadata.bpm);
        }

        // æŸ¥æ‰¾ offset
        function searchOffset(obj) {
            if (typeof obj === "object" && obj !== null) {
                for (let key in obj) {
                    if (key === "offset" && typeof obj[key] === "number") {
                        metadata.offset = obj[key];
                        console.log("æ‰¾åˆ°offset:", metadata.offset);
                        return;
                    } else {
                        searchOffset(obj[key]);
                        if (metadata.offset !== 0) return;
                    }
                }
            }
        }
        searchOffset(jsonData);

        console.log("=== æœ€ç»ˆæå–çš„å…ƒæ•°æ® ===");
        console.log("title:", metadata.title);
        console.log("artist:", metadata.artist);
        console.log("bpm:", metadata.bpm);
        console.log("offset:", metadata.offset);

        return metadata;
    }

    // æ·±åº¦æœç´¢å…ƒæ•°æ®
    function deepSearchForMetadata(obj, path = '') {
        const result = { title: null, artist: null };

        if (typeof obj !== 'object' || obj === null) {
            return result;
        }

        // æ£€æŸ¥å½“å‰å±‚çº§
        if (obj.title && typeof obj.title === 'string') {
            result.title = obj.title;
        }
        if (obj.artist && typeof obj.artist === 'string') {
            result.artist = obj.artist;
        }
        if (obj.author && typeof obj.author === 'string' && !result.artist) {
            result.artist = obj.author;
        }

        // å¦‚æœå·²ç»æ‰¾åˆ°ä¸¤ä¸ªå€¼ï¼Œç›´æ¥è¿”å›
        if (result.title && result.artist) {
            return result;
        }

        // é€’å½’æœç´¢å­å¯¹è±¡
        for (const key in obj) {
            if (typeof obj[key] === 'object' && obj[key] !== null) {
                const subResult = deepSearchForMetadata(obj[key], path + '.' + key);
                if (!result.title && subResult.title) {
                    result.title = subResult.title;
                }
                if (!result.artist && subResult.artist) {
                    result.artist = subResult.artist;
                }

                // å¦‚æœå·²ç»æ‰¾åˆ°ä¸¤ä¸ªå€¼ï¼Œæå‰é€€å‡º
                if (result.title && result.artist) {
                    return result;
                }
            }
        }

        return result;
    }

    // ç”Ÿæˆä¸Šä¼ ä¿¡æ¯.txtå†…å®¹
    function generateUploadInfoTxt(metadata, levelNum, startTime) {
        return `æ­Œæ›²åï¼š${metadata.title}
æ›²å¸ˆï¼š${metadata.artist}
BPMï¼š${metadata.bpm.toFixed(1)}
èµ·å§‹æ—¶é—´ï¼š${startTime.toFixed(4)}
ç­‰çº§ï¼š${levelNum}`;
    }

    // ç”ŸæˆmusicInfo.jsonå†…å®¹
    function generateMusicInfoJson(metadata, levelNum, startTime) {
        const now = new Date();
        const formattedDate = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }).replace(/\//g, '/');

        return {
            uuid: "",
            name: metadata.title,  // ä½¿ç”¨ä»MCæ–‡ä»¶æå–çš„title
            autor: metadata.artist, // ä½¿ç”¨ä»MCæ–‡ä»¶æå–çš„artist
            bpm: metadata.bpm,
            firstTime: startTime,
            bpmList: {},
            c_time: formattedDate,
            e_time: formattedDate
        };
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(jsonData, filteredNotes, offset, startTime) {
        // æå–å…ƒæ•°æ®
        mcMetadata = extractMetadataFromMC(jsonData);
        mcMetadata.startTime = startTime;

        document.getElementById('baseBPM').textContent = globalTimeList[0].bpm.toFixed(2);
        document.getElementById('offsetValue').textContent = offset;
        document.getElementById('startTime').textContent = startTime.toFixed(4);
        document.getElementById('noteCount').textContent = filteredNotes.length;

        document.getElementById('bpmCount').textContent = `${globalTimeList.length} ä¸ªåŒºé—´`;

        const tableBody = document.getElementById('bpmTableBody');
        tableBody.innerHTML = '';

        globalTimeList.forEach((time, i) => {
            const beatVal = beatArrayToFloat(time.beat);
            const duration = i < globalTimeList.length - 1
                ? (beatArrayToFloat(globalTimeList[i+1].beat) - beatVal).toFixed(2)
                : 'âˆ';

            const row = document.createElement('tr');
            row.innerHTML = `
          <td class="text-bold">${i}</td>
          <td class="text-bold">${beatVal.toFixed(2)}</td>
          <td class="text-bold">${time.bpm}</td>
          <td class="text-bold">${duration}</td>
        `;
            tableBody.appendChild(row);
        });

        const convertTime = Date.now() - conversionStartTime;
        document.getElementById('convertTime').textContent = convertTime;

        // ç”Ÿæˆå¹¶æ˜¾ç¤ºä¿¡æ¯æ–‡ä»¶å†…å®¹
        const levelNum = levelNumberInput.value || "1";
        const uploadInfoTxt = generateUploadInfoTxt(mcMetadata, levelNum, startTime);
        const musicInfoJson = generateMusicInfoJson(mcMetadata, levelNum, startTime);

        // æ˜¾ç¤ºåœ¨ä¿¡æ¯é€‰é¡¹å¡ä¸­
        document.getElementById('outputInfo').value =
            `=== ä¸Šä¼ ä¿¡æ¯.txt ===\n${uploadInfoTxt}\n\n=== musicInfo.json ===\n${JSON.stringify(musicInfoJson, null, 2)}`;

        // åœ¨çŠ¶æ€æ æ˜¾ç¤ºæå–çš„å…ƒæ•°æ®
        showStatus(`å·²æå–: ${mcMetadata.title} - ${mcMetadata.artist}`, 'success');
    }

    // è½¬æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    convertBtn.addEventListener('click', async function() {
        if (!fileInput.files.length) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
            return;
        }

        if (isMCZFile && internalFileSelect.value === "") {
            showStatus('è¯·ä» MCZ æ–‡ä»¶ä¸­é€‰æ‹©ä¸€ä¸ª MC æ–‡ä»¶', 'error');
            return;
        }

        conversionStartTime = Date.now();

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const originalText = convertBtn.innerHTML;
        convertBtn.innerHTML = '<span class="loading"></span> è½¬æ¢ä¸­...';
        convertBtn.disabled = true;

        try {
            let jsonContent;
            let fileName;

            if (isMCZFile) {
                const fileIndex = parseInt(internalFileSelect.value);
                const mcFile = await readMCZFile(fileIndex);
                jsonContent = mcFile.content;
                fileName = mcFile.name;

                // æå–MCZä¸­çš„éŸ³é¢‘å’Œå›¾ç‰‡æ–‡ä»¶
                if (mczAudioFile) {
                    showStatus('æ­£åœ¨æå–éŸ³é¢‘æ–‡ä»¶...', 'info');
                    extraAudioFile = await extractMediaFileFromMCZ(mczAudioFile);
                }
                if (mczImageFile) {
                    showStatus('æ­£åœ¨æå–å›¾ç‰‡æ–‡ä»¶...', 'info');
                    extraImageFile = await extractMediaFileFromMCZ(mczImageFile);
                }
                updateExtraFilesList();

            } else {
                const file = fileInput.files[0];
                fileName = file.name;
                jsonContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                    reader.readAsText(file);
                });
            }

            globalJsonData = JSON.parse(jsonContent);
            globalTimeList = globalJsonData.time;

            if (!globalTimeList || globalTimeList.length === 0) {
                throw new Error('æœªæ‰¾åˆ° time åˆ—è¡¨');
            }

            let offset = null;
            function searchOffset(obj) {
                if (typeof obj === "object" && obj !== null) {
                    for (let key in obj) {
                        if (key === "offset" && typeof obj[key] === "number") {
                            offset = obj[key];
                            return;
                        } else {
                            searchOffset(obj[key]);
                            if (offset !== null) return;
                        }
                    }
                }
            }
            searchOffset(globalJsonData);

            if (offset === null) {
                throw new Error('æœªæ‰¾åˆ° offset');
            }

            const noteList = globalJsonData.note;
            if (!noteList || noteList.length === 0) {
                throw new Error('æœªæ‰¾åˆ° note åˆ—è¡¨');
            }

            const filteredNotes = noteList.filter(note => !("sound" in note));
            const baseBPM = globalTimeList[0].bpm;
            const firstNoteBeat = beatArrayToFloat(filteredNotes[0].beat);
            const firstConverted = convertBeat(firstNoteBeat, globalTimeList, baseBPM);
            const startTime = 60 / baseBPM * firstNoteBeat - offset / 1000;

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats(globalJsonData, filteredNotes, offset, startTime);

            // ç”Ÿæˆæ™®é€š note çš„ TXT è¡Œ
            let txtLines = [];
            filteredNotes.forEach(note => {
                const col = note.column;
                const colStr = (col + 1).toString();
                const noteStart = beatArrayToFloat(note.beat);
                const convStart = convertBeat(noteStart, globalTimeList, baseBPM) - firstConverted;
                let line = "";
                if ("endbeat" in note) {
                    const noteEnd = beatArrayToFloat(note.endbeat);
                    const convEnd = convertBeat(noteEnd, globalTimeList, baseBPM) - firstConverted;
                    line = `${colStr}-${convStart.toFixed(2)}-${convEnd.toFixed(2)}`;
                } else {
                    line = `${colStr}-${convStart.toFixed(2)}`;
                }
                txtLines.push(line);
            });
            globalNormalLines = txtLines;

            // æ›´æ–°è¾“å‡ºæ˜¾ç¤º
            updateOutputDisplay();

            // ç”Ÿæˆ SV TXT è¡Œ
            let effectLines = [];
            if (globalJsonData.effect && Array.isArray(globalJsonData.effect) && globalJsonData.effect.length > 0) {
                globalJsonData.effect.forEach(eff => {
                    if ("scroll" in eff) {
                        const effBeat = beatArrayToFloat(eff.beat);
                        const convEff = convertBeat(effBeat, globalTimeList, baseBPM) - firstConverted;
                        effectLines.push(`${convEff.toFixed(2)},${eff.scroll}`);
                    }
                });
            }
            globalEffectLines = effectLines;
            document.getElementById('outputSV').value = effectLines.join("\n");

            // æ˜¾ç¤ºåŸå§‹æ•°æ®
            document.getElementById('outputRaw').value = JSON.stringify(globalJsonData, null, 2);

            // å¯ç”¨ä¸‹è½½æŒ‰é’®
            downloadBtn.disabled = false;
            zipBtn.disabled = false;
            downloadBtn.classList.add('pulse');
            zipBtn.classList.add('pulse');

            showStatus('è½¬æ¢å®Œæˆï¼å¯ä»¥ä¸‹è½½æ–‡ä»¶äº†', 'success');

            if (document.getElementById('autoDownload').checked) {
                setTimeout(() => {
                    downloadBtn.click();
                }, 500);
            }

        } catch (err) {
            showStatus('è½¬æ¢å‡ºé”™ï¼š' + err.message, 'error');
            console.error('è½¬æ¢é”™è¯¯:', err);
        } finally {
            convertBtn.innerHTML = originalText;
            convertBtn.disabled = false;
        }
    });

    // æ›´æ–°è¾“å‡ºæ˜¾ç¤º
    function updateOutputDisplay() {
        if (!globalNormalLines) return;
        const mergeChecked = mergeCheckbox.checked;
        let displayLines = [];
        if (mergeChecked) {
            displayLines = mergeLines(globalNormalLines);
        } else {
            displayLines = globalNormalLines;
        }
        document.getElementById('outputNormal').value = displayLines.join("\n");
    }

    mergeCheckbox.addEventListener('change', updateOutputDisplay);

    // ä¸‹è½½TXTæ–‡ä»¶æŒ‰é’®äº‹ä»¶
    downloadBtn.addEventListener('click', function() {
        if (!globalNormalLines) {
            showStatus('è¯·å…ˆè¿›è¡Œè½¬æ¢ï¼', 'error');
            return;
        }

        const mergeChecked = mergeCheckbox.checked;
        let normalLinesToDownload = [];
        if (mergeChecked) {
            normalLinesToDownload = mergeLines(globalNormalLines);
        } else {
            normalLinesToDownload = globalNormalLines;
        }
        const normalOutput = normalLinesToDownload.join("\n");

        const levelNum = levelNumberInput.value || "1";
        const paddedNum = levelNum.padStart(3, '0');
        const downloadNameNormal = `${selectedLevel}${paddedNum}.txt`;

        // ä¸‹è½½æ™®é€š TXT æ–‡ä»¶
        try {
            const blobNormal = new Blob([normalOutput], { type: "text/plain;charset=utf-8" });
            const urlNormal = URL.createObjectURL(blobNormal);
            const aNormal = document.createElement("a");
            aNormal.href = urlNormal;
            aNormal.download = downloadNameNormal;
            aNormal.style.display = "none";
            document.body.appendChild(aNormal);
            aNormal.click();
            document.body.removeChild(aNormal);
            URL.revokeObjectURL(urlNormal);
        } catch (err) {
            showStatus('ä¸‹è½½æ™®é€šæ–‡ä»¶å¤±è´¥: ' + err.message, 'error');
            return;
        }

        // å¦‚æœ effect æœ‰æ•°æ®ï¼Œåˆ™ä¸‹è½½ SV TXT æ–‡ä»¶
        if (globalEffectLines && globalEffectLines.length > 0) {
            try {
                const effectOutput = globalEffectLines.join("\n");
                const svFilename = `${selectedLevel}${paddedNum}_SV.txt`;
                const blobSV = new Blob([effectOutput], { type: "text/plain;charset=utf-8" });
                const urlSV = URL.createObjectURL(blobSV);
                const aSV = document.createElement("a");
                aSV.href = urlSV;
                aSV.download = svFilename;
                aSV.style.display = "none";
                document.body.appendChild(aSV);
                aSV.click();
                document.body.removeChild(aSV);
                URL.revokeObjectURL(urlSV);
            } catch (err) {
                showStatus('ä¸‹è½½SVæ–‡ä»¶å¤±è´¥: ' + err.message, 'error');
            }
        }

        showStatus(`TXTæ–‡ä»¶ä¸‹è½½å®Œæˆï¼æ–‡ä»¶å: ${downloadNameNormal}`, 'success');
    });

    // æ‰“åŒ…ä¸‹è½½ZIPæŒ‰é’®äº‹ä»¶
    zipBtn.addEventListener('click', async function() {
        if (!globalNormalLines) {
            showStatus('è¯·å…ˆè¿›è¡Œè½¬æ¢ï¼', 'error');
            return;
        }

        const originalText = zipBtn.innerHTML;
        zipBtn.innerHTML = '<span class="loading"></span> æ‰“åŒ…ä¸­...';
        zipBtn.disabled = true;

        try {
            // ç¡®ä¿JSZipå¯ç”¨
            if (!window.JSZip) {
                await loadJSZip();
            }

            const zip = new JSZip();

            // 1. æ·»åŠ æ™®é€šTXTæ–‡ä»¶
            const mergeChecked = mergeCheckbox.checked;
            let normalLinesToDownload = [];
            if (mergeChecked) {
                normalLinesToDownload = mergeLines(globalNormalLines);
            } else {
                normalLinesToDownload = globalNormalLines;
            }
            const normalOutput = normalLinesToDownload.join("\n");

            const levelNum = levelNumberInput.value || "1";
            const paddedNum = levelNum.padStart(3, '0');
            const txtFilename = `${selectedLevel}${paddedNum}.txt`;

            zip.file(txtFilename, normalOutput);

            // 2. æ·»åŠ SV TXTæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
            if (globalEffectLines && globalEffectLines.length > 0) {
                const effectOutput = globalEffectLines.join("\n");
                const svFilename = `${selectedLevel}${paddedNum}_SV.txt`;
                zip.file(svFilename, effectOutput);
            }

            // 3. æ·»åŠ ä¸Šä¼ ä¿¡æ¯.txt
            const uploadInfoTxt = generateUploadInfoTxt(mcMetadata, levelNum, mcMetadata.startTime);
            zip.file("ä¸Šä¼ ä¿¡æ¯.txt", uploadInfoTxt);

            // 4. æ·»åŠ musicInfo.json
            const musicInfoJson = generateMusicInfoJson(mcMetadata, levelNum, mcMetadata.startTime);
            zip.file("musicInfo.json", JSON.stringify(musicInfoJson, null, 2));

            // 5. æ·»åŠ éŸ³é¢‘æ–‡ä»¶ï¼ˆé‡å‘½åä¸ºaudioï¼‰
            if (extraAudioFile) {
                const audioExt = extraAudioFile.name.split('.').pop().toLowerCase();
                zip.file(`audio.${audioExt}`, extraAudioFile);
            } else if (mczAudioFile) {
                // ä»MCZä¸­æå–éŸ³é¢‘
                const audioBlob = await mczAudioFile.zipEntry.async('blob');
                const audioExt = mczAudioFile.name.split('.').pop().toLowerCase();
                zip.file(`audio.${audioExt}`, audioBlob);
            }

            // 6. æ·»åŠ å›¾ç‰‡æ–‡ä»¶ï¼ˆé‡å‘½åä¸ºbgï¼‰
            if (extraImageFile) {
                const imageExt = extraImageFile.name.split('.').pop().toLowerCase();
                zip.file(`bg.${imageExt}`, extraImageFile);
            } else if (mczImageFile) {
                // ä»MCZä¸­æå–å›¾ç‰‡
                const imageBlob = await mczImageFile.zipEntry.async('blob');
                const imageExt = mczImageFile.name.split('.').pop().toLowerCase();
                zip.file(`bg.${imageExt}`, imageBlob);
            }

            // ç”ŸæˆZIPæ–‡ä»¶
            const zipBlob = await zip.generateAsync({ type: "blob" });

            // ä¸‹è½½ZIPæ–‡ä»¶
            const zipUrl = URL.createObjectURL(zipBlob);
            const a = document.createElement("a");
            a.href = zipUrl;
            a.download = `${selectedLevel}${paddedNum}_package.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(zipUrl);

            showStatus(`ZIPåŒ…ä¸‹è½½å®Œæˆï¼åŒ…å«æ‰€æœ‰å¿…éœ€æ–‡ä»¶`, 'success');

        } catch (err) {
            console.error('æ‰“åŒ…ZIPå¤±è´¥:', err);
            showStatus(`æ‰“åŒ…ZIPå¤±è´¥: ${err.message}`, 'error');
        } finally {
            zipBtn.innerHTML = originalText;
            zipBtn.disabled = false;
        }
    });

    // é‡ç½®æŒ‰é’®
    resetBtn.addEventListener('click', function() {
        fileInput.value = '';
        fileInfo.textContent = 'ç­‰å¾…æ–‡ä»¶é€‰æ‹©...';
        fileInfo.classList.remove('highlight');
        fileSelector.classList.remove('active');
        internalFileSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦è½¬æ¢çš„ MC æ–‡ä»¶...</option>';
        mczFilesList.innerHTML = '';

        extraFilesArea.classList.remove('active');
        audioInput.value = '';
        imageInput.value = '';
        audioPreview.textContent = '';
        imagePreview.textContent = '';
        extraFilesList.innerHTML = '';

        cleanupZipInstance();
        globalNormalLines = null;
        globalEffectLines = null;
        globalJsonData = null;
        globalTimeList = null;
        isMCZFile = false;
        extraAudioFile = null;
        extraImageFile = null;
        mczAudioFile = null;
        mczImageFile = null;
        mcMetadata = { title: "", artist: "", bpm: 0, offset: 0, startTime: 0 };

        document.getElementById('outputNormal').value = '';
        document.getElementById('outputSV').value = '';
        document.getElementById('outputRaw').value = '';
        document.getElementById('outputInfo').value = '';

        document.getElementById('baseBPM').textContent = '--';
        document.getElementById('offsetValue').textContent = '--';
        document.getElementById('startTime').textContent = '--';
        document.getElementById('noteCount').textContent = '--';
        document.getElementById('fileSize').textContent = '--';
        document.getElementById('convertTime').textContent = '--';

        document.getElementById('bpmCount').textContent = '0 ä¸ªåŒºé—´';
        document.getElementById('bpmTableBody').innerHTML = `
        <tr>
          <td colspan="4" style="text-align: center; padding: 50px; color: var(--text-tertiary);">
            <div style="font-size: 40px; margin-bottom: 20px;">ğŸ“Š</div>
            <div class="text-bold">é€‰æ‹©æ–‡ä»¶å¹¶å¼€å§‹è½¬æ¢åï¼ŒBPM æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
          </td>
        </tr>
      `;

        downloadBtn.disabled = true;
        zipBtn.disabled = true;
        downloadBtn.classList.remove('pulse');
        zipBtn.classList.remove('pulse');
        convertBtn.disabled = true;

        showStatus('å·²é‡ç½®æ‰€æœ‰æ•°æ®', 'info');
    });

    // å¼ºåˆ¶é‡ç½®æŒ‰é’®
    forceResetBtn.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦å¼ºåˆ¶é‡ç½®è§£å‹å™¨å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è§£å‹çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦é‡æ–°ä¸Šä¼ æ–‡ä»¶ã€‚')) {
            forceResetExtractor();
        }
    });

    // é€‰é¡¹å¡åˆ‡æ¢
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.dataset.tab;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        });
    });

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
        initLevelSelection();
        updateFilenamePreview();

        fileInfo.textContent = 'ç­‰å¾…æ–‡ä»¶é€‰æ‹©...';
        downloadBtn.disabled = true;
        zipBtn.disabled = true;
        convertBtn.disabled = true;

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'o':
                        e.preventDefault();
                        fileInput.click();
                        break;
                    case 'c':
                        if (!convertBtn.disabled) {
                            e.preventDefault();
                            convertBtn.click();
                        }
                        break;
                    case 'd':
                        if (!downloadBtn.disabled) {
                            e.preventDefault();
                            downloadBtn.click();
                        }
                        break;
                    case 'z':
                        if (!zipBtn.disabled) {
                            e.preventDefault();
                            zipBtn.click();
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        resetBtn.click();
                        break;
                    case 'f':
                        if (e.ctrlKey && e.shiftKey) {
                            e.preventDefault();
                            forceResetBtn.click();
                        }
                        break;
                    case '1': case '2': case '3': case '4': case '5':
                        if (e.ctrlKey && !e.shiftKey) {
                            e.preventDefault();
                            const levelIndex = parseInt(e.key) - 1;
                            if (levelIndex >= 0 && levelIndex < levelButtons.length) {
                                levelButtons[levelIndex].click();
                            }
                        }
                        break;
                }
            }
        });
    });

    //ç¦æ­¢å³é”®
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        console.log('å³é”®å·²è¢«ç¦ç”¨');
        return false;
    });

    // ç¦æ­¢é€‰æ‹©æ–‡æœ¬ï¼ˆå¯é€‰ï¼Œé˜²æ­¢ç”¨æˆ·å¤åˆ¶å†…å®¹ï¼‰
    document.addEventListener('selectstart', function(e) {
        e.preventDefault();
        return false;
    });

    // ç¦æ­¢æ‹–æ‹½å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œé˜²æ­¢ç”¨æˆ·æ‹–æ‹½ä¿å­˜å›¾ç‰‡ï¼‰
    document.addEventListener('dragstart', function(e) {
        if (e.target.tagName === 'IMG') {
            e.preventDefault();
            return false;
        }
    });

    // ç¦æ­¢F12å¼€å‘è€…å·¥å…·ï¼ˆç®€å•ç‰ˆæœ¬ï¼Œä½†å®¹æ˜“è¢«ç»•è¿‡ï¼‰
    document.addEventListener('keydown', function(e) {
        // ç¦ç”¨F12
        if (e.key === 'F12') {
            e.preventDefault();
            console.log('F12å·²è¢«ç¦ç”¨');
            return false;
        }
        // ç¦ç”¨Ctrl+Shift+I (Chromeå¼€å‘è€…å·¥å…·)
        if (e.ctrlKey && e.shiftKey && e.key === 'I') {
            e.preventDefault();
            console.log('Ctrl+Shift+Iå·²è¢«ç¦ç”¨');
            return false;
        }
        // ç¦ç”¨Ctrl+Shift+J (Chromeæ§åˆ¶å°)
        if (e.ctrlKey && e.shiftKey && e.key === 'J') {
            e.preventDefault();
            console.log('Ctrl+Shift+Jå·²è¢«ç¦ç”¨');
            return false;
        }
        // ç¦ç”¨Ctrl+U (æŸ¥çœ‹æºä»£ç )
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            console.log('Ctrl+Uå·²è¢«ç¦ç”¨');
            return false;
        }
    });
</script>


</body>
</html>